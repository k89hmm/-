<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Space Game</title>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython.min.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
<style>
    body {
        background-color: black;
        color: white;
        text-align: center;
        margin: 0;
        overflow: hidden;
        user-select: none;
        touch-action: none;
    }
    #gameCanvas {
        background: url('background.png') no-repeat center center;
        background-size: cover;
        display: block;
        margin: 20px auto;
        border: 2px solid white;
    }
    #overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        color: white;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        font-size: 24px;
    }
</style>
</head>
<body onload="brython()">

<h1>ğŸš€ SPACE GAME ğŸš€</h1>
<button id="startBtn">ê²Œì„ ì‹œì‘</button>
<p id="score">ì ìˆ˜: 0</p>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="overlay"></div>

<script type="text/python">
from browser import document, html, timer, window
import random

# Firebase ì—°ê²° ì„¤ì •
firebaseConfig = {
    'apiKey': "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
    'authDomain': "aaaa-85ddd.firebaseapp.com",
    'databaseURL': "https://aaaa-85ddd-default-rtdb.firebaseio.com",
    'projectId': "aaaa-85ddd",
    'storageBucket': "aaaa-85ddd.firebasestorage.app",
    'messagingSenderId': "947357162592",
    'appId': "1:947357162592:web:599896666a79b4b219f705",
    'measurementId': "G-KVHXK6GR39"
}

# Firebase ì´ˆê¸°í™”
app = window.firebase.initializeApp(firebaseConfig)
db = window.firebase.database()

canvas = document["gameCanvas"]
ctx = canvas.getContext("2d")

player = {"x": 400, "y": 500, "size": 25}
bullets = []
score = 0
running = False
ranking = []

overlay = document["overlay"]

# ì „ì—­ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸°
def load_ranking():
    global ranking
    def callback(snapshot):
        data = snapshot.val()
        if data:
            ranking = sorted(
                [int(data[key]["score"]) for key in window.Object.keys(data)],
                reverse=True
            )
    db.ref("ranking").get().then(callback)

load_ranking()

# ì „ì—­ ë­í‚¹ ì €ì¥
def save_score(new_score):
    ref = db.ref("ranking").push()
    ref.set({"score": new_score})

def draw():
    ctx.clearRect(0, 0, canvas.width, canvas.height)
    ctx.beginPath()
    ctx.arc(player["x"], player["y"], player["size"], 0, 3.14*2)
    ctx.fillStyle = "cyan"
    ctx.fill()
    for b in bullets:
        ctx.beginPath()
        ctx.arc(b["x"], b["y"], 8, 0, 3.14*2)
        ctx.fillStyle = "red"
        ctx.fill()

def update():
    global score, running
    for b in bullets:
        b["y"] += b["speed"]
    bullets[:] = [b for b in bullets if b["y"] < 600]
    if random.random() < 0.02:
        bullets.append({"x": random.randint(0, 800), "y": 0, "speed": random.uniform(2,5)})
    for b in bullets:
        dx, dy = b["x"] - player["x"], b["y"] - player["y"]
        dist = (dx**2 + dy**2)**0.5
        if dist < player["size"] + 8:
            running = False
            game_over()
            return
    score += 1
    document["score"].text = f"ì ìˆ˜: {score}"

def game_over():
    global score
    save_score(score)
    load_ranking()
    overlay.style.display = "flex"
    overlay.innerHTML = f"<h2>ğŸ’€ ê²Œì„ ì˜¤ë²„ ğŸ’€</h2><p>ë‹¹ì‹ ì˜ ì ìˆ˜: {score}</p><h3>ğŸ† ìƒìœ„ 5ìœ„ ğŸ†</h3>"
    if ranking:
        top5 = ranking[:5]
        overlay.innerHTML += "<br>".join([f"{i+1}ë“±: {s}ì " for i, s in enumerate(top5)])
        if score < top5[-1]:
            overlay.innerHTML += "<p>5ë“± ì•ˆì— ëª» ë“¤ì—ˆìŠµë‹ˆë‹¤ ğŸ˜¢</p>"

def game_loop():
    if running:
        update()
        draw()
        timer.set_timeout(game_loop, 30)

def start_game(event=None):
    global running, score, bullets, player
    overlay.style.display = "none"
    player["x"], player["y"] = 400, 500
    score = 0
    bullets = []
    running = True
    game_loop()

# í‚¤ë³´ë“œ ì´ë™
def on_key(event):
    key = event.keyCode
    if key == 37 and player["x"] > 20: player["x"] -= 20
    elif key == 39 and player["x"] < 780: player["x"] += 20
    elif key == 38 and player["y"] > 20: player["y"] -= 20
    elif key == 40 and player["y"] < 580: player["y"] += 20

# ëª¨ë°”ì¼ í„°ì¹˜ ì´ë™
def on_touch(event):
    event.preventDefault()
    touch = event.touches[0]
    rect = canvas.getBoundingClientRect()
    player["x"] = touch.clientX - rect.left
    player["y"] = touch.clientY - rect.top

document.bind("keydown", on_key)
document["gameCanvas"].bind("touchmove", on_touch)
document["startBtn"].bind("click", start_game)
</script>
</body>
</html>
