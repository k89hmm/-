<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>게임</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        body { margin:0; overflow:hidden; }
        #score { position:absolute; top:10px; right:10px; font-size:20px; color:white; }
        #game-over {
            position:absolute; top:0; left:0; width:100%; height:100%;
            display:none; justify-content:center; align-items:center;
            flex-direction:column; background:rgba(0,0,0,0.7);
            color:white; font-size:30px;
        }
    </style>
</head>
<body onload="brython()">
    <div id="score">Score: 0</div>
    <div id="game-over">
        <div id="go-text">게임 오버</div>
        <div id="go-score"></div>
        <div id="ranking"></div>
        <div id="fail-msg"></div>
    </div>
    <canvas id="game"></canvas>

    <script type="text/python">
from browser import document, html, window
import random, json

# --------------------------
# Firebase 설정
# --------------------------
firebaseConfig = {
    'apiKey': "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
    'authDomain': "aaaa-85ddd.firebaseapp.com",
    'databaseURL': "https://aaaa-85ddd-default-rtdb.firebaseio.com",
    'projectId': "aaaa-85ddd",
    'storageBucket': "aaaa-85ddd.firebasestorage.app",
    'messagingSenderId': "947357162592",
    'appId': "1:947357162592:web:599896666a79b4b219f705",
    'measurementId': "G-KVHXK6GR39"
}

window.firebase.initializeApp(firebaseConfig)
db = window.firebase.database()

# --------------------------
# 게임 변수
# --------------------------
canvas = document['game']
ctx = canvas.getContext('2d')
canvas.width = window.innerWidth
canvas.height = window.innerHeight

score_div = document['score']
game_over_div = document['game-over']
go_score_div = document['go-score']
ranking_div = document['ranking']
fail_msg_div = document['fail-msg']

bg = window.Image.new()
bg.src = "background.png"

player_img = window.Image.new()
player_img.src = "player.png"

bullet_img = window.Image.new()
bullet_img.src = "bullet.png"

player = {"x": canvas.width//2, "y": canvas.height//2, "w":50, "h":50}
bullets = []
keys = {"up":False, "down":False, "left":False, "right":False}

game_running = False
score = 0
ranking = []

# --------------------------
# 입력 처리
# --------------------------
def key_down(ev):
    if ev.code in ("ArrowUp","KeyW"): keys["up"]=True
    if ev.code in ("ArrowDown","KeyS"): keys["down"]=True
    if ev.code in ("ArrowLeft","KeyA"): keys["left"]=True
    if ev.code in ("ArrowRight","KeyD"): keys["right"]=True

def key_up(ev):
    if ev.code in ("ArrowUp","KeyW"): keys["up"]=False
    if ev.code in ("ArrowDown","KeyS"): keys["down"]=False
    if ev.code in ("ArrowLeft","KeyA"): keys["left"]=False
    if ev.code in ("ArrowRight","KeyD"): keys["right"]=False

document.bind("keydown", key_down)
document.bind("keyup", key_up)

# 모바일 터치
touch = {"active":False}
def touch_start(ev):
    touch["active"] = True
    touch["x"]=ev.touches[0].clientX
    touch["y"]=ev.touches[0].clientY
    ev.preventDefault()

def touch_move(ev):
    if touch["active"]:
        player["x"]=ev.touches[0].clientX
        player["y"]=ev.touches[0].clientY
    ev.preventDefault()

def touch_end(ev):
    touch["active"]=False
    ev.preventDefault()

canvas.bind("touchstart", touch_start)
canvas.bind("touchmove", touch_move)
canvas.bind("touchend", touch_end)

# --------------------------
# 총알
# --------------------------
def create_bullet():
    if not game_running: return
    # stage 밖 위에서 랜덤 x로 생성
    bx = random.randint(0, canvas.width)
    by = -20
    bullets.append({"x":bx,"y":by,"w":20,"h":20})
    # 1초마다 반복 생성
    window.setTimeout(create_bullet, 1000)

def update_bullets():
    for b in bullets:
        b["y"] += 5
        # 충돌 감지
        if abs(b["x"]-player["x"])<30 and abs(b["y"]-player["y"])<30:
            game_over()
    bullets[:] = [b for b in bullets if b["y"] < canvas.height]

# --------------------------
# 점수 & 랭킹
# --------------------------
def load_ranking():
    def callback(snapshot):
        global ranking
        data = snapshot.val()
        if data is None:
            ranking = []
        else:
            ranking = sorted([int(d["score"]) for d in data.values()], reverse=True)
    db.ref("ranking").on("value", callback)

def save_score():
    player_name = window.prompt("이름을 입력하세요", "Player")
    db.ref("ranking").push({"name":player_name,"score":score})

# --------------------------
# 게임 오버
# --------------------------
def game_over():
    global game_running
    if not game_running: return
    game_running = False
    game_over_div.style.display = "flex"
    go_score_div.text = f"점수: {score}"

    top5 = ranking[:5]
    ranking_div.text = ""
    for i,d in enumerate(top5):
        ranking_div <= html.DIV(f"{i+1}위: {d}")
    if score < top5[-1] if top5 else 0:
        fail_msg_div.text = "5등 안에 못 들었습니다"
    else:
        fail_msg_div.text = ""

    save_score()

# --------------------------
# 게임 루프
# --------------------------
def update():
    global score
    if keys["up"]: player["y"]-=5
    if keys["down"]: player["y"]+=5
    if keys["left"]: player["x"]-=5
    if keys["right"]: player["x"]+=5
    update_bullets()
    score += 1
    score_div.text = f"Score: {score}"

def draw():
    ctx.clearRect(0,0,canvas.width,canvas.height)
    ctx.drawImage(bg,0,0,canvas.width,canvas.height)
    ctx.drawImage(player_img, player["x"]-player["w"]/2, player["y"]-player["h"]/2, player["w"], player["h"])
    for b in bullets:
        ctx.drawImage(bullet_img, b["x"]-b["w"]/2, b["y"]-b["h"]/2, b["w"], b["h"])

def game_loop(ts):
    if not game_running: return
    update()
    draw()
    window.requestAnimationFrame(game_loop)

def start_game(ev=None):
    global game_running, score, bullets
    score = 0
    bullets = []
    game_running = True
    game_over_div.style.display = "none"
    player["x"] = canvas.width//2
    player["y"] = canvas.height//2
    create_bullet()  # 총알 생성 시작
    window.requestAnimationFrame(game_loop)

# 시작 버튼
start_btn = html.BUTTON("게임 시작")
start_btn.bind("click", start_game)
document <= start_btn

# 랭킹 로드
window.setTimeout(load_ranking, 500)

    </script>
</body>
</html>
