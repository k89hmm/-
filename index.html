<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>슈팅 게임</title>
    <style>
        body { margin:0; overflow:hidden; background:black; }
        canvas { display:block; margin:0 auto; background:#000; }
        #ranking { position:absolute; top:10px; left:10px; color:white; font-family:sans-serif; }
        #gameover { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
                    color:white; font-size:2em; display:none; text-align:center; font-family:sans-serif; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython_stdlib.min.js"></script>
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        const firebaseConfig = {
    'apiKey': "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
    'authDomain': "aaaa-85ddd.firebaseapp.com",
    'databaseURL': "https://aaaa-85ddd-default-rtdb.firebaseio.com",
    'projectId': "aaaa-85ddd",
    'storageBucket': "aaaa-85ddd.firebasestorage.app",
    'messagingSenderId': "947357162592",
    'appId': "1:947357162592:web:599896666a79b4b219f705",
    'measurementId': "G-KVHXK6GR39"
        };
        window.firebaseApp = initializeApp(firebaseConfig);
        window.firebaseDB = getDatabase(window.firebaseApp);
    </script>
</head>
<body onload="brython()">
<canvas id="game"></canvas>
<div id="ranking"></div>
<div id="gameover"></div>
<script type="text/python">
from browser import document, html, window, timer

canvas = document["game"]
ctx = canvas.getContext("2d")
canvas.width = window.innerWidth
canvas.height = window.innerHeight

# 이미지 로드
bg_img = window.Image.new()
bg_img.src = "background.png"
player_img = window.Image.new()
player_img.src = "player.png"
bullet_img = window.Image.new()
bullet_img.src = "bullet.png"

player = {'x': canvas.width//2, 'y': canvas.height-100, 'w':50, 'h':50}
bullets = []
keys = {'left':False, 'right':False, 'up':False, 'down':False}

score = 0
game_over_flag = False

# Firebase DB
db = window.firebaseDB
score_ref = window.ref(db, "scores")

def update_ranking():
    def callback(snapshot):
        try:
            data = snapshot.val()
            if data is None:
                top_scores = []
            else:
                # 모든 점수 리스트
                top_scores = sorted([int(d["score"]) for d in data.values()], reverse=True)
            # 상위 5명 표시
            display = ""
            for i, s in enumerate(top_scores[:5]):
                display += f"{i+1}. {s}\n"
            if score > 0 and (score not in top_scores[:5]):
                display += f"Your score: {score}\n"
            document["ranking"].text = display
        except Exception as e:
            print("Ranking update error:", e)
    window.onValue(score_ref, callback)

def add_score():
    window.push(score_ref, {"score": score})

def game_over():
    global game_over_flag
    game_over_flag = True
    document["gameover"].style.display = "block"
    document["gameover"].text = f"Game Over\nScore: {score}"
    add_score()
    update_ranking()

def move_player():
    speed = 7
    if keys['left'] and player['x'] > 0:
        player['x'] -= speed
    if keys['right'] and player['x'] < canvas.width - player['w']:
        player['x'] += speed
    if keys['up'] and player['y'] > 0:
        player['y'] -= speed
    if keys['down'] and player['y'] < canvas.height - player['h']:
        player['y'] += speed

def game_loop(timestamp=None):
    global score
    if game_over_flag:
        return
    ctx.clearRect(0,0,canvas.width,canvas.height)
    # 배경
    ctx.drawImage(bg_img, 0,0, canvas.width, canvas.height)
    move_player()
    # 플레이어
    ctx.drawImage(player_img, player['x'], player['y'], player['w'], player['h'])
    # 총알
    new_bullets = []
    for b in bullets:
        b['y'] -= 10
        if b['y'] > 0:
            ctx.drawImage(bullet_img, b['x'], b['y'], b['w'], b['h'])
            new_bullets.append(b)
        else:
            score += 1
    bullets[:] = new_bullets
    window.requestAnimationFrame(game_loop)

# 총알 생성 (stage 밖에서 들어오도록)
def spawn_bullet():
    if not game_over_flag:
        import random
        x = random.randint(0, canvas.width-20)
        bullets.append({'x': x, 'y': canvas.height+10, 'w':20, 'h':20})
        timer.set_timeout(spawn_bullet, 1000)

# 키보드 이벤트
def key_down(ev):
    code = ev.key
    if code in ["ArrowLeft","a","A"]: keys['left'] = True
    if code in ["ArrowRight","d","D"]: keys['right'] = True
    if code in ["ArrowUp","w","W"]: keys['up'] = True
    if code in ["ArrowDown","s","S"]: keys['down'] = True

def key_up(ev):
    code = ev.key
    if code in ["ArrowLeft","a","A"]: keys['left'] = False
    if code in ["ArrowRight","d","D"]: keys['right'] = False
    if code in ["ArrowUp","w","W"]: keys['up'] = False
    if code in ["ArrowDown","s","S"]: keys['down'] = False

document.bind("keydown", key_down)
document.bind("keyup", key_up)

# 모바일 터치 드래그
dragging = False
def touch_start(ev):
    global dragging
    dragging = True
def touch_move(ev):
    global dragging
    if dragging:
        player['x'] = ev.touches[0].clientX - player['w']//2
        player['y'] = ev.touches[0].clientY - player['h']//2
def touch_end(ev):
    global dragging
    dragging = False

document.bind("touchstart", touch_start)
document.bind("touchmove", touch_move)
document.bind("touchend", touch_end)

# 시작
spawn_bullet()
window.requestAnimationFrame(game_loop)
update_ranking()

</script>
</body>
</html>
