<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ì¢Œí˜•ì˜ ì•ˆë¯¼ì²  í”¼í•˜ê¸°</title>
<style>
body {
    margin:0; padding:20px;
    background:#111;
    font-family:system-ui;
    color:#fff;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
}
h1 {margin:0; text-align:center;}
#controls {
    display:flex; gap:12px; align-items:center;
}
button {
    padding:8px 12px;
    border-radius:6px;
    border:none;
    background:#2b6df6;
    color:white;
    cursor:pointer;
}
#score { font-weight:700; }
canvas {
    width:100%;
    max-width:480px;
    height:auto;
    background:#000;
    border-radius:8px;
    box-shadow:0 6px 24px rgba(0,0,0,0.6);
    display:block;
    touch-action: none;
}

/* âœ… ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
#overlay {
    position: absolute;
    top: 0; left: 50%;
    transform: translateX(-50%);
    width: 480px;
    height: 640px;
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    background: rgba(0,0,0,0.7);
    border-radius: 8px;
    text-align: center;
    color: white;
}
#overlay h2 { font-size: 48px; margin-bottom: 12px; }
#overlay p { font-size: 24px; margin-bottom: 16px; }
#overlay input {
    padding: 8px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
    text-align: center;
    width: 200px;
    margin-bottom: 8px;
}
#overlay button {
    background:#2b6df6;
    color:white;
    padding:8px 12px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size:16px;
    margin-bottom: 10px;
}
#overlay #top-scores {
    font-size: 18px;
    line-height: 1.6;
    margin-top: 10px;
}
</style>

<!-- âœ… Firebase Realtime Database CDN -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, push, get, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
    authDomain: "aaaa-85ddd.firebaseapp.com",
    databaseURL: "https://aaaa-85ddd-default-rtdb.firebaseio.com",
    projectId: "aaaa-85ddd",
    storageBucket: "aaaa-85ddd.firebasestorage.app",
    messagingSenderId: "947357162592",
    appId: "1:947357162592:web:599896666a79b4b219f705",
    measurementId: "G-KVHXK6GR39"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// âœ… ì ìˆ˜ ì—…ë¡œë“œ
window.uploadScore = async function(name, score){
    try{
        const scoresRef = ref(db, 'ranking');
        await push(scoresRef, { name: name, score: score });
        console.log("Uploading:", name, score);
        await window.showTopScores();
    } catch(err){
        console.error("Firebase upload error:", err);
    }
};

// âœ… ìƒìœ„ 5ëª… í‘œì‹œ
window.showTopScores = async function(){
    try {
        const scoresRef = query(ref(db, 'ranking'), orderByChild('score'), limitToLast(5));
        const snapshot = await get(scoresRef);
        const list = [];
        snapshot.forEach(child => { list.push(child.val()); });
        list.sort((a,b)=>b.score - a.score);

        let html = "<h3>ğŸ† ìƒìœ„ 5ìœ„</h3>";
        list.forEach((item,i)=>{ html += `${i+1}. ${item.name} - ${item.score}<br>`; });
        const div = document.getElementById("top-scores");
        div.innerHTML = html;
    } catch(err) {
        console.error("Show top scores error:", err);
    }
};
</script>

<script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython_stdlib.js"></script>
</head>
<body onload="brython()">

<h1>ì¢Œí˜•ì˜ ì•ˆë¯¼ì²  í”¼í•˜ê¸°</h1>
<div id="controls">
  <button id="start">ì‹œì‘</button>
  <div id="score">ì ìˆ˜: 0</div>
</div>
<canvas id="game" width="480" height="640"></canvas>

<!-- âœ… ì˜¤ë²„ë ˆì´: ê²Œì„ ì˜¤ë²„ + ì´ë¦„ ì…ë ¥ + ìƒìœ„ 5ìœ„ -->
<div id="overlay">
  <h2>ê²Œì„ ì˜¤ë²„</h2>
  <p id="final-score">ìµœì¢… ì ìˆ˜: 0</p>
  <input type="text" id="player-name" placeholder="ì´ë¦„ ì…ë ¥">
  <button id="submit-name">ì ìˆ˜ ì œì¶œ</button>
  <div id="top-scores"></div>
</div>

<script type="text/python3">
from browser import document, html, timer, window
import math, random

CANVAS = document['game']
ctx = CANVAS.getContext('2d')
STAGE_W, STAGE_H = 480, 640

player = {'x': STAGE_W/2, 'y': STAGE_H/2, 'w':50, 'h':50, 'speed':6}
bullets = []
spawn_interval = 700
last_spawn = 0
running = False
game_started = False
score = 0
keys = {'left':False,'right':False,'up':False,'down':False}
difficulty_timer = 0
player_loaded = False
bullet_loaded = False
bg_loaded = False

# âœ… ì´ë¯¸ì§€ ë¡œë”©
player_img = html.IMG(); player_img.src='player.png'
player_img.bind('load', lambda ev: globals().update({'player_loaded': True}))
bullet_img = html.IMG(); bullet_img.src='bullet.png'
bullet_img.bind('load', lambda ev: globals().update({'bullet_loaded': True}))
bg_img = html.IMG(); bg_img.src='background.png'
bg_img.bind('load', lambda ev: globals().update({'bg_loaded': True}))

def spawn_bullet():
    side = random.choice(['top','bottom','left','right'])
    size = random.uniform(6,14)
    speed = random.uniform(2.0,4.2)+(score/200.0)
    if side=='top':
        x=random.uniform(0,STAGE_W); y=-size; vx=random.uniform(-1,1); vy=speed
    elif side=='bottom':
        x=random.uniform(0,STAGE_W); y=STAGE_H+size; vx=random.uniform(-1,1); vy=-speed
    elif side=='left':
        x=-size; y=random.uniform(0,STAGE_H); vx=speed; vy=random.uniform(-1,1)
    else:
        x=STAGE_W+size; y=random.uniform(0,STAGE_H); vx=-speed; vy=random.uniform(-1,1)
    bullets.append({'x':x,'y':y,'vx':vx,'vy':vy,'r':size})

def update(dt):
    global last_spawn, score, running, difficulty_timer
    if not running: return
    last_spawn += dt
    difficulty_timer += dt
    if last_spawn>=spawn_interval: last_spawn=0; spawn_bullet()
    if difficulty_timer>=5000:
        difficulty_timer=0
        for b in bullets: b['vx']*=1.5; b['vy']*=1.5
    if keys['left']: player['x']-=player['speed']
    if keys['right']: player['x']+=player['speed']
    if keys['up']: player['y']-=player['speed']
    if keys['down']: player['y']+=player['speed']
    player['x']=max(player['w']/2,min(STAGE_W-player['w']/2,player['x']))
    player['y']=max(player['h']/2,min(STAGE_H-player['h']/2,player['y']))
    for b in list(bullets):
        b['x']+=b['vx']; b['y']+=b['vy']
        if b['x']<-50 or b['x']>STAGE_W+50 or b['y']<-50 or b['y']>STAGE_H+50:
            bullets.remove(b); score+=1
    # âœ… ì¶©ëŒ ê°ì§€: íˆíŠ¸ë°•ìŠ¤ ì ìš©
    player_hit_w = player['w']/2
    player_hit_h = player['h']
    for b in bullets:
        bullet_hit_w = b['r']*2*6
        bullet_hit_h = bullet_hit_w * 1.5
        rx = player['x'] - player_hit_w/2
        ry = player['y'] - player_hit_h/2
        closest_x = max(rx, min(b['x'], rx + player_hit_w))
        closest_y = max(ry, min(b['y'], ry + player_hit_h))
        dx = b['x'] - closest_x
        dy = b['y'] - closest_y
        if dx*dx + dy*dy <= (bullet_hit_h/2)**2:
            running=False; break

def draw():
    ctx.clearRect(0,0,STAGE_W,STAGE_H)
    if bg_loaded: ctx.drawImage(bg_img,0,0,STAGE_W,STAGE_H)
    if player_loaded:
        ratio=player_img.naturalWidth/player_img.naturalHeight
        draw_w=player['w']/2; draw_h=draw_w/ratio
        ctx.drawImage(player_img,player['x']-draw_w/2,player['y']-draw_h/2,draw_w,draw_h)
    for b in bullets:
        if bullet_loaded:
            ratio=bullet_img.naturalWidth/bullet_img.naturalHeight
            draw_w=b['r']*6; draw_h=draw_w/ratio
            ctx.drawImage(bullet_img,b['x']-draw_w/2,b['y']-draw_h/2,draw_w,draw_h)
        else:
            ctx.beginPath(); ctx.arc(b['x'],b['y'],b['r']*3,0,2*math.pi)
            ctx.fillStyle='#ff6b6b'; ctx.fill()
    # âœ… íˆíŠ¸ë°•ìŠ¤ ì‹œê°í™”
    ctx.strokeStyle = 'lime'; ctx.lineWidth = 2
    player_hit_w = player['w']/2
    player_hit_h = player['h']
    ctx.strokeRect(player['x']-player_hit_w/2, player['y']-player_hit_h/2, player_hit_w, player_hit_h)
    for b in bullets:
        bullet_hit_w = b['r']*2*6
        bullet_hit_h = bullet_hit_w * 1.5
        ctx.strokeStyle = 'red'; ctx.lineWidth = 2
        ctx.strokeRect(b['x']-bullet_hit_w/2, b['y']-bullet_hit_h/2, bullet_hit_w, bullet_hit_h)
    document['score'].text=f"ì ìˆ˜: {score}"

def show_game_over():
    ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.fillRect(0,0,STAGE_W,STAGE_H)
    ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'
    center_y = STAGE_H / 2
    ctx.font = '48px sans-serif'; ctx.fillText('ê²Œì„ ì˜¤ë²„', STAGE_W/2, center_y - 20)
    ctx.font = '24px sans-serif'; ctx.fillText(f'ìµœì¢… ì ìˆ˜: {score}', STAGE_W/2, center_y + 30)
    document['overlay'].style.display = 'flex'
    document['final-score'].text = f"ìµœì¢… ì ìˆ˜: {score}"
    window.showTopScores()

def submit_name(ev):
    name = document['player-name'].value.strip()
    if name:
        window.uploadScore(name, score)
        document['overlay'].style.display = 'none'

document['submit-name'].bind('click', submit_name)

def game_loop():
    update(16); draw()
    if not running and game_started: show_game_over()

def on_keydown(ev):
    if ev.key in ('ArrowLeft','a'): keys['left']=True
    if ev.key in ('ArrowRight','d'): keys['right']=True
    if ev.key in ('ArrowUp','w'): keys['up']=True
    if ev.key in ('ArrowDown','s'): keys['down']=True
    if ev.key in ('ArrowLeft','ArrowRight','ArrowUp','ArrowDown'): ev.preventDefault()

def on_keyup(ev):
    if ev.key in ('ArrowLeft','a'): keys['left']=False
    if ev.key in ('ArrowRight','d'): keys['right']=False
    if ev.key in ('ArrowUp','w'): keys['up']=False
    if ev.key in ('ArrowDown','s'): keys['down']=False
    if ev.key in ('ArrowLeft','ArrowRight','ArrowUp','ArrowDown'): ev.preventDefault()

document.bind('keydown',on_keydown); document.bind('keyup',on_keyup)

def on_touch(ev):
    if not running: return
    touch = ev.touches[0]
    rect = CANVAS.getBoundingClientRect()
    player['x'] = (touch.clientX - rect.left) * (STAGE_W / rect.width)
    player['y'] = (touch.clientY - rect.top) * (STAGE_H / rect.height)
    ev.preventDefault()

document['game'].bind('touchstart', on_touch)
document['game'].bind('touchmove', on_touch)

def start_game(ev=None):
    global running, bullets, score, last_spawn, difficulty_timer, player, game_started
    bullets=[]; score=0; last_spawn=0; difficulty_timer=0
    running=True; game_started=True
    player['x']=STAGE_W/2; player['y']=STAGE_H/2
    document['overlay'].style.display = 'none'
    document['player-name'].value = ''

document['start'].bind('click',start_game)

def all_images_loaded():
    return player_img.complete and bullet_img.complete and bg_img.complete

def start_loop_when_ready(ts):
    if all_images_loaded(): timer.request_animation_frame(loop)
    else: timer.set_timeout(lambda: start_loop_when_ready(ts),50)

def loop(ts):
    game_loop(); timer.request_animation_frame(loop)

start_loop_when_ready(0)
</script>
</body>
</html>
