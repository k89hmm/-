<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>좌형의 안민철 피하기</title>
<style>
body {margin:0; padding:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial; background:#111; color:#eee; display:flex; flex-direction:column; align-items:center;}
#header {display:flex; flex-direction:column; align-items:center; gap:8px; margin-top:12px;}
#controls {display:flex; gap:12px; align-items:center;}
button {padding:8px 16px; border:none; border-radius:6px; background:#2b6df6; color:white; cursor:pointer; font-size:16px;}
#score {font-weight:700; font-size:18px;}
canvas {background:#000; border-radius:8px; margin-top:12px; touch-action:none;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython_stdlib.js"></script>
</head>
<body onload="brython()">
<div id="header">
<h1>좌형의 안민철 피하기</h1>
<div id="controls">
<button id="start">게임 시작</button>
<div id="score">점수: 0</div>
</div>
</div>
<canvas id="game" width="480" height="640"></canvas>

<script type="text/python3">
from browser import document, html, timer, window, prompt
import math, random

CANVAS = document['game']
ctx = CANVAS.getContext('2d')
W,H = CANVAS.width, CANVAS.height

player = {'x':W/2,'y':H/2,'w':50,'h':50,'speed':6}
player_img = html.IMG()
player_img.src = 'player.png'
player_loaded = False
def on_player_load(ev): global player_loaded; player_loaded=True
player_img.bind('load', on_player_load)

bg_img = html.IMG()
bg_img.src = 'background.png'
bg_loaded = False
def on_bg_load(ev): global bg_loaded; bg_loaded=True
bg_img.bind('load', on_bg_load)

bullets = []
score = 0
running = False
keys = {'left':False,'right':False,'up':False,'down':False}

# Firebase 설정
firebaseConfig = {
  'apiKey': "YOUR_API_KEY",
  'authDomain': "YOUR_PROJECT.firebaseapp.com",
  'databaseURL': "YOUR_DATABASE_URL",
  'projectId': "YOUR_PROJECT_ID",
  'storageBucket': "YOUR_PROJECT.appspot.com",
  'messagingSenderId': "YOUR_SENDER_ID",
  'appId': "YOUR_APP_ID",
  'measurementId': "YOUR_MEASUREMENT_ID"
}

firebase = window.firebase
app = firebase.initializeApp(firebaseConfig)
db = firebase.database()

# 총알 생성
def spawn_bullet():
    edge=random.choice(['top','bottom','left','right'])
    r=random.uniform(10,14)
    speed=random.uniform(1.5,2.5)
    if edge=='top': x,y=random.uniform(0,W),-r*2; vx=random.uniform(-0.3,0.3); vy=speed
    elif edge=='bottom': x,y=random.uniform(0,W),H+r*2; vx=random.uniform(-0.3,0.3); vy=-speed
    elif edge=='left': x,y=-r*2,random.uniform(0,H); vx=speed; vy=random.uniform(-0.3,0.3)
    else: x,y=W+r*2,random.uniform(0,H); vx=-speed; vy=random.uniform(-0.3,0.3)
    bullets.append({'x':x,'y':y,'vx':vx,'vy':vy,'r':r})

def update(dt):
    global score,running
    if not running: return
    if keys['left']: player['x']-=player['speed']
    if keys['right']: player['x']+=player['speed']
    if keys['up']: player['y']-=player['speed']
    if keys['down']: player['y']+=player['speed']
    player['x']=max(player['w']/2,min(W-player['w']/2,player['x']))
    player['y']=max(player['h']/2,min(H-player['h']/2,player['y']))
    for b in bullets[:]:
        b['x']+=b['vx']; b['y']+=b['vy']
        if b['x']<-b['r'] or b['x']>W+b['r'] or b['y']<-b['r'] or b['y']>H+b['r']:
            bullets.remove(b); score+=1
    for b in bullets:
        dx = b['x']-player['x']; dy = b['y']-player['y']
        if (dx*dx)/(player['w']**2*0.2) + (dy*dy)/(player['h']**2*0.5) <= b['r']*b['r']:
            running=False; game_over(); break

def draw():
    ctx.clearRect(0,0,W,H)
    if bg_loaded: ctx.drawImage(bg_img,0,0,W,H)
    if player_loaded: ctx.drawImage(player_img,player['x']-player['w']/2,player['y']-player['h']/2,player['w'],player['h'])
    else: ctx.fillStyle='#66ff99'; ctx.fillRect(player['x']-player['w']/2,player['y']-player['h']/2,player['w'],player['h'])
    for b in bullets:
        ctx.beginPath(); ctx.arc(b['x'],b['y'],b['r'],0,2*math.pi); ctx.fillStyle='#ff6b6b'; ctx.fill()
    document['score'].text=f"점수: {score}"

def game_loop():
    update(16)
    draw()
    if running:
        if random.random()<0.05: spawn_bullet()

def on_keydown(ev):
    if ev.key in ('ArrowLeft','a'): keys['left']=True
    if ev.key in ('ArrowRight','d'): keys['right']=True
    if ev.key in ('ArrowUp','w'): keys['up']=True
    if ev.key in ('ArrowDown','s'): keys['down']=True
def on_keyup(ev):
    if ev.key in ('ArrowLeft','a'): keys['left']=False
    if ev.key in ('ArrowRight','d'): keys['right']=False
    if ev.key in ('ArrowUp','w'): keys['up']=False
    if ev.key in ('ArrowDown','s'): keys['down']=False

def on_touch(ev):
    if not running: return
    t=ev.touches[0]
    player['x']=t.clientX*W/window.innerWidth
    player['y']=t.clientY*H/window.innerHeight
    ev.preventDefault()
document.bind('touchmove', on_touch)

def start_game(ev=None):
    global score, bullets, running
    score=0; bullets=[]; player['x'],player['y']=W/2,H/2; running=True

def game_over():
    # 화면 반투명
    ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(0,0,W,H)
    ctx.fillStyle='#fff'; ctx.font='48px sans-serif'; ctx.textAlign='center'
    ctx.fillText('게임 오버',W/2,H/2-50)
    ctx.font='24px sans-serif'; ctx.fillText(f'최종 점수: {score}',W/2,H/2)
    # 이름 입력
    name = prompt("이름을 입력하세요", "익명")
    if not name: name="익명"
    ref = db.ref("ranking")
    # 데이터 가져오기 후 정렬
    def callback(snapshot):
        data = snapshot.val() or {}
        data[name]=score
        items = sorted(data.items(), key=lambda x:x[1], reverse=True)[:5]
        ref.set(dict(items))
        # 순위 표시
        y=H/2+40
        for i,(n,s) in enumerate(items):
            ctx.fillText(f"{i+1}. {n}: {s}", W/2, y+30*i)
        if name not in dict(items):
            ctx.fillText("5등 안에 못 들었습니다", W/2, y+30*5)
    ref.get().then(callback)

document.bind('keydown',on_keydown)
document.bind('keyup',on_keyup)
document['start'].bind('click',start_game)
timer.set_interval(game_loop,16)
</script>
</body>
</html>
