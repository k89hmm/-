<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ì¢Œí˜•ì˜ ì•ˆë¯¼ì²  í”¼í•˜ê¸°</title>
  <style>
    html, body {margin:0;padding:0;overflow:hidden;height:100%;width:100%;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial;color:#eee;background:#111;}
    #controls {display:flex;gap:8px;align-items:center;padding:10px;}
    button {padding:8px 12px;border-radius:6px;border:none;background:#2b6df6;color:white;cursor:pointer;}
    #score {font-weight:700;}
    #game {display:block;margin:0 auto;background:#000;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,0.6);}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython_stdlib.js"></script>
</head>
<body onload="brython()">
  <h1 style="text-align:center;">ì¢Œí˜•ì˜ ì•ˆë¯¼ì²  í”¼í•˜ê¸°</h1>
  <div id="controls">
    <button id="start">ê²Œì„ ì‹œì‘</button>
    <div id="score">ì ìˆ˜: 0</div>
  </div>
  <canvas id="game"></canvas>

  <script type="text/python3">
from browser import document, html, timer, window
import math, random, json

# --- í™”ë©´ í¬ê¸° ì„¤ì • ---
CANVAS = document['game']
ctx = CANVAS.getContext('2d')

def resize_canvas():
    global STAGE_W, STAGE_H
    STAGE_W = window.innerWidth - 20
    STAGE_H = window.innerHeight - 140
    CANVAS.width = STAGE_W
    CANVAS.height = STAGE_H

resize_canvas()
window.bind("resize", lambda ev: resize_canvas())

# --- ê²Œì„ ë³€ìˆ˜ ---
player = {'x':0, 'y':0, 'w':50, 'h':50, 'speed':6}
bullets = []
spawn_interval = 700
last_spawn = 0
running = False
score = 0
keys = {'left': False, 'right': False, 'up': False, 'down': False}
difficulty_timer = 0
player_loaded = False
player_ratio = 1.0

# --- ì´ë¯¸ì§€ ---
player_img = html.IMG()
player_img.src = 'player.png'  # ì—¬ê¸°ì— ì›í•˜ëŠ” í”Œë ˆì´ì–´ ì´ë¯¸ì§€
bullet_img = html.IMG()
bullet_img.src = 'bullet.png'  # ì—¬ê¸°ì— ì›í•˜ëŠ” ì´ì•Œ ì´ë¯¸ì§€
background_img = html.IMG()
background_img.src = 'background.jpg'  # ì›í•˜ëŠ” ë°°ê²½ ì´ë¯¸ì§€
bg_loaded = False

def player_load(ev): global player_loaded; player_loaded=True
def bg_load(ev): global bg_loaded; bg_loaded=True
player_img.bind('load', player_load)
background_img.bind('load', bg_load)

# --- ì´ˆê¸° ìœ„ì¹˜ ---
def reset_player_pos():
    player['x'] = STAGE_W/2
    player['y'] = STAGE_H/2
reset_player_pos()

# --- ì´ì•Œ ìƒì„± ---
def spawn_bullet():
    side = random.choice(['top','bottom','left','right'])
    size = random.uniform(20, 40)  # í™•ëŒ€
    speed = random.uniform(2.0, 4.0) + score/200.0
    if side=='top':
        x = random.uniform(0, STAGE_W)
        y = -size
        vx = random.uniform(-0.6,0.6)
        vy = speed
    elif side=='bottom':
        x = random.uniform(0, STAGE_W)
        y = STAGE_H + size
        vx = random.uniform(-0.6,0.6)
        vy = -speed
    elif side=='left':
        x = -size
        y = random.uniform(0, STAGE_H)
        vx = speed
        vy = random.uniform(-0.6,0.6)
    else:  # right
        x = STAGE_W + size
        y = random.uniform(0, STAGE_H)
        vx = -speed
        vy = random.uniform(-0.6,0.6)
    bullets.append({'x':x,'y':y,'vx':vx,'vy':vy,'r':size})

# --- ê²Œì„ ë¡œì§ ---
def update(dt):
    global last_spawn, score, difficulty_timer, running
    if not running: return
    last_spawn += dt
    difficulty_timer += dt
    if last_spawn>=spawn_interval: last_spawn=0; spawn_bullet()

    # ë‚œì´ë„ ì¦ê°€
    if difficulty_timer>=5000:
        difficulty_timer=0
        for b in bullets: b['vx']*=1.2; b['vy']*=1.2

    # í”Œë ˆì´ì–´ ì´ë™
    if keys['left']: player['x']-=player['speed']
    if keys['right']: player['x']+=player['speed']
    if keys['up']: player['y']-=player['speed']
    if keys['down']: player['y']+=player['speed']

    # í™”ë©´ ì œí•œ
    player['x'] = max(player['w']/2, min(STAGE_W-player['w']/2, player['x']))
    player['y'] = max(player['h']/2, min(STAGE_H-player['h']/2, player['y']))

    # ì´ì•Œ ì´ë™
    for b in list(bullets):
        b['x'] += b['vx']
        b['y'] += b['vy']
        if b['x']<-100 or b['x']>STAGE_W+100 or b['y']<-100 or b['y']>STAGE_H+100:
            bullets.remove(b)
            score+=1

    # ì¶©ëŒ ì²´í¬ (ì¢Œìš° 20%, ìƒí•˜ 50%)
    for b in bullets:
        rx = player['x'] - player['w']/2
        ry = player['y'] - player['h']/2
        closest_x = max(rx, min(b['x'], rx + player['w']))
        closest_y = max(ry, min(b['y'], ry + player['h']))
        dx = b['x'] - closest_x
        dy = b['y'] - closest_y
        if dx*dx/5 + dy*dy/2 <= b['r']*b['r']:
            running=False
            show_game_over()
            break

# --- ê·¸ë¦¬ê¸° ---
def draw():
    # ë°°ê²½
    if bg_loaded:
        ctx.drawImage(background_img,0,0,STAGE_W,STAGE_H)
        ctx.fillStyle='rgba(255,255,255,0.6)'
        ctx.fillRect(0,0,STAGE_W,STAGE_H)  # ë°ê¸° 60%
    else:
        ctx.fillStyle="#111"; ctx.fillRect(0,0,STAGE_W,STAGE_H)

    # í”Œë ˆì´ì–´
    if player_loaded:
        draw_w = player['w']*player_ratio
        draw_h = player['h']*player_ratio
        ctx.drawImage(player_img, player['x']-draw_w/2, player['y']-draw_h/2, draw_w, draw_h)
    else:
        ctx.fillStyle="#66ff99"
        ctx.fillRect(player['x']-player['w']/2, player['y']-player['h']/2, player['w'], player['h'])

    # ì´ì•Œ
    for b in bullets:
        if bullet_img.src:
            ctx.drawImage(bullet_img,b['x']-b['r'],b['y']-b['r'],b['r']*2,b['r']*2)
        else:
            ctx.beginPath()
            ctx.arc(b['x'],b['y'],b['r'],0,2*math.pi)
            ctx.fillStyle='#ff6b6b'
            ctx.fill()

    document['score'].text = f"ì ìˆ˜: {score}"

# --- ê²Œì„ ë£¨í”„ ---
def game_loop():
    update(16)
    draw()

def loop(ts):
    game_loop()
    timer.request_animation_frame(loop)

timer.request_animation_frame(loop)

# --- í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ---
def on_keydown(ev):
    if ev.key in ('ArrowLeft','a'): keys['left']=True
    if ev.key in ('ArrowRight','d'): keys['right']=True
    if ev.key in ('ArrowUp','w'): keys['up']=True
    if ev.key in ('ArrowDown','s'): keys['down']=True

def on_keyup(ev):
    if ev.key in ('ArrowLeft','a'): keys['left']=False
    if ev.key in ('ArrowRight','d'): keys['right']=False
    if ev.key in ('ArrowUp','w'): keys['up']=False
    if ev.key in ('ArrowDown','s'): keys['down']=False

document.bind('keydown',on_keydown)
document.bind('keyup',on_keyup)

# --- í„°ì¹˜ ì´ë²¤íŠ¸ ---
def on_touch(ev):
    ev.preventDefault()
    touches = ev.touches
    if touches.length>0:
        t = touches[0]
        player['x'] = t.clientX
        player['y'] = t.clientY

document['game'].bind('touchstart',on_touch)
document['game'].bind('touchmove',on_touch)

# --- ê²Œì„ ì‹œì‘ ---
def start_game(ev=None):
    global bullets, score, last_spawn, difficulty_timer, running
    bullets=[]
    score=0
    last_spawn=0
    difficulty_timer=0
    running=True
    reset_player_pos()

document['start'].bind('click',start_game)

# --- ê²Œì„ ì˜¤ë²„ í™”ë©´ ---
def show_game_over():
    global running
    # ì–´ë‘¡ê²Œ ì²˜ë¦¬
    ctx.fillStyle='rgba(0,0,0,0.5)'
    ctx.fillRect(0,0,STAGE_W,STAGE_H)

    ctx.fillStyle='#fff'
    ctx.textAlign='center'

    # ê²Œì„ ì˜¤ë²„ ë©”ì‹œì§€
    ctx.font='48px sans-serif'
    ctx.fillText('ê²Œì„ ì˜¤ë²„',STAGE_W/2,60)
    ctx.font='28px sans-serif'
    ctx.fillText(f'ìµœì¢… ì ìˆ˜: {score}',STAGE_W/2,120)

    # ì´ë¦„ ì…ë ¥
    name = window.prompt("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:","í”Œë ˆì´ì–´")
    if not name: name="ìµëª…"

    # ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸°
    ranking_json = window.localStorage.getItem('ranking')
    ranking = json.loads(ranking_json) if ranking_json else []

    ranking.append({'name':name,'score':score})
    ranking = sorted(ranking,key=lambda x:x['score'],reverse=True)[:5]
    window.localStorage.setItem('ranking',json.dumps(ranking))

    # ìƒìœ„ 5ëª… ì¶œë ¥
    ctx.font='20px sans-serif'
    ctx.fillText("ğŸ† ìƒìœ„ 5ëª…",STAGE_W/2,180)
    for i,entry in enumerate(ranking):
        ctx.fillText(f"{i+1}. {entry['name']} : {entry['score']}",STAGE_W/2,210+i*30)

    # 5ë“± ì•ˆì— ëª» ë“  ê²½ìš°
    if not any(entry['name']==name and entry['score']==score for entry in ranking):
        ctx.fillText("5ë“± ì•ˆì— ëª» ë“¤ì—ˆìŠµë‹ˆë‹¤",STAGE_W/2,360)
  </script>
</body>
</html>
