<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>좌형의 안민철 피하기</title>
<style>
body { margin:0; overflow:hidden; font-family:sans-serif; }
#game-container { position: relative; width: 100vw; height: 100vh; background: #000; }
#game-canvas { display: block; margin: auto; background: #000; }
#ui { position: absolute; top:10px; left:50%; transform:translateX(-50%); color:white; text-align:center; }
#score { display:inline-block; margin-left:20px; }
#game-over { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white; font-size:2em; display:none; text-align:center; }
button { padding:10px 20px; font-size:1em; cursor:pointer; }
</style>

<script src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython_stdlib.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

</head>
<body onload="brython()">

<div id="game-container">
    <canvas id="game-canvas" width="800" height="600"></canvas>
    <div id="ui">
        <div id="title">좌형의 안민철 피하기</div>
        <button id="start-btn">게임 시작</button>
        <span id="score">점수: 0</span>
    </div>
    <div id="game-over">
        <div id="over-text">게임 오버</div>
        <div id="final-score"></div>
        <div id="ranking-list"></div>
    </div>
</div>

<script type="text/python">
from browser import document, html, window
import random, math

canvas = document['game-canvas']
ctx = canvas.getContext('2d')
canvas_width = canvas.width
canvas_height = canvas.height

bg = window.Image.new()
bg.src = "background.png"

player_img = window.Image.new()
player_img.src = "player.png"

bullet_img = window.Image.new()
bullet_img.src = "bullet.png"

player = {}
bullets = []
score = 0
game_running = False

# Firebase 설정
firebaseConfig = {
    'apiKey': "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
    'authDomain': "aaaa-85ddd.firebaseapp.com",
    'databaseURL': "https://aaaa-85ddd-default-rtdb.firebaseio.com",
    'projectId': "aaaa-85ddd",
    'storageBucket': "aaaa-85ddd.firebasestorage.app",
    'messagingSenderId': "947357162592",
    'appId': "1:947357162592:web:599896666a79b4b219f705",
    'measurementId': "G-KVHXK6GR39"
}

firebase = window.firebase
firebase.initializeApp(firebaseConfig)
db = firebase.database()

ranking = []

def load_ranking():
    def callback(snapshot):
        global ranking
        data = snapshot.val()
        if data:
            ranking = sorted([int(d['score']) for d in data.values()], reverse=True)[:5]
        else:
            ranking = []
    db.ref('/ranking').on('value', callback)

def save_score(new_score):
    db.ref('/ranking').push({ 'score': new_score })

def start_game(ev):
    global game_running, player, bullets, score
    game_running = True
    player['x'] = canvas_width/2
    player['y'] = canvas_height/2
    player['w'] = player_img.width/2
    player['h'] = player_img.height/2
    bullets = []
    score = 0
    document['score'].text = "점수: 0"
    document['game-over'].style.display = 'none'
    window.requestAnimationFrame(game_loop)

document['start-btn'].bind('click', start_game)

def spawn_bullet():
    x = random.randint(0, canvas_width-20)
    y = -20
    bullets.append({'x':x, 'y':y, 'w':bullet_img.width/2, 'h':bullet_img.height/2})

def check_collision(b):
    return (player['x']-player['w']/2 < b['x']+b['w'] and
            player['x']+player['w']/2 > b['x'] and
            player['y']-player['h']/2 < b['y']+b['h'] and
            player['y']+player['h']/2 > b['y'])

def update(dt):
    global score, game_running
    for b in bullets[:]:
        b['y'] += 5
        if check_collision(b):
            game_over()
            return
        if b['y'] > canvas_height:
            bullets.remove(b)
    score += 1
    document['score'].text = f"점수: {score}"

def game_over():
    global game_running
    game_running = False
    document['game-over'].style.display = 'block'
    document['final-score'].text = f"점수: {score}"
    save_score(score)
    load_ranking()
    ranking_text = ""
    for i, s in enumerate(ranking):
        ranking_text += f"{i+1}위: {s}점\n"
    if len(ranking) < 5 or score < ranking[-1]:
        ranking_text += "\n5등 안에 못 들었습니다."
    document['ranking-list'].text = ranking_text
    ctx.fillStyle = "rgba(0,0,0,0.5)"
    ctx.fillRect(0,0,canvas_width,canvas_height)

def game_loop(timestamp):
    if not game_running:
        return
    update(16)
    ctx.clearRect(0,0,canvas_width,canvas_height)
    ctx.drawImage(bg, 0, 0, canvas_width, canvas_height)
    ctx.drawImage(player_img, player['x']-player['w']/2, player['y']-player['h']/2, player['w'], player['h'])
    for b in bullets:
        ctx.drawImage(bullet_img, b['x'], b['y'], b['w'], b['h'])
    window.requestAnimationFrame(game_loop)
    if random.random() < 0.02:
        spawn_bullet()

# 키보드 이동
keys = set()
def keydown(ev): keys.add(ev.key)
def keyup(ev): keys.discard(ev.key)
document.bind('keydown', keydown)
document.bind('keyup', keyup)

def handle_keys():
    speed = 5
    if 'ArrowUp' in keys or 'w' in keys: player['y'] -= speed
    if 'ArrowDown' in keys or 's' in keys: player['y'] += speed
    if 'ArrowLeft' in keys or 'a' in keys: player['x'] -= speed
    if 'ArrowRight' in keys or 'd' in keys: player['x'] += speed

# 모바일 터치 이동
touch_active = False
def touch_start(ev): global touch_active; touch_active = True
def touch_end(ev): global touch_active; touch_active = False
def touch_move(ev):
    if touch_active:
        touch = ev.touches[0]
        player['x'] = touch.clientX
        player['y'] = touch.clientY

canvas.bind('touchstart', touch_start)
canvas.bind('touchend', touch_end)
canvas.bind('touchmove', touch_move)

# 메인 루프
def main_loop():
    if game_running:
        handle_keys()
    window.requestAnimationFrame(lambda t: main_loop())

main_loop()
</script>

</body>
</html>
