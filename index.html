<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Bullet Game</title>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython_stdlib.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        body { margin:0; overflow:hidden; }
        canvas { display:block; background:#000; }
    </style>
</head>
<body onload="brython()">

<canvas id="gameCanvas" width="480" height="640"></canvas>

<script type="text/python">
from browser import document, window

# === Firebase 설정 ===
firebaseConfig = {
    'apiKey': "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
    'authDomain': "aaaa-85ddd.firebaseapp.com",
    'databaseURL': "https://aaaa-85ddd-default-rtdb.firebaseio.com",
    'projectId': "aaaa-85ddd",
    'storageBucket': "aaaa-85ddd.firebasestorage.app",
    'messagingSenderId': "947357162592",
    'appId': "1:947357162592:web:599896666a79b4b219f705",
    'measurementId': "G-KVHXK6GR39"
}
window.firebase.initializeApp(firebaseConfig)
db = window.firebase.database()

# === 캔버스 ===
canvas = document['gameCanvas']
ctx = canvas.getContext('2d')
canvas_width = canvas.width
canvas_height = canvas.height

# === 이미지 로드 ===
bg_img = window.Image.new()
bg_img.src = "background.png"
player_img = window.Image.new()
player_img.src = "player.png"
bullet_img = window.Image.new()
bullet_img.src = "bullet.png"

# === 게임 상태 ===
player = {'x': canvas_width/2, 'y': canvas_height - 100, 'w': 50, 'h': 50}
bullets = []
score = 0
ranking_list = []
game_over_flag = False

# === JS Object -> Python dict 변환 ===
def js_to_py(obj):
    py_dict = {}
    for k in window.Object.keys(obj):
        py_dict[k] = obj[k]
    return py_dict

# === 랭킹 표시 ===
def show_ranking():
    ctx.fillStyle = "white"
    ctx.font = "20px Arial"
    ctx.fillText(f"Score: {score}", 20, 30)
    ctx.fillText("Ranking Top 5:", 20, 60)
    for i, s in enumerate(ranking_list[:5]):
        ctx.fillText(f"{i+1}. {s}", 20, 90 + i*30)
    if ranking_list and score < ranking_list[-1]:
        ctx.fillText("5등 안에 못 들었습니다", 20, 250)

# === 게임 오버 ===
def game_over():
    global game_over_flag
    game_over_flag = True
    ctx.fillStyle = "rgba(0,0,0,0.5)"
    ctx.fillRect(0,0,canvas_width,canvas_height)
    ctx.fillStyle = "red"
    ctx.font = "40px Arial"
    ctx.fillText("GAME OVER", canvas_width/2-120, 200)
    ctx.fillStyle = "white"
    ctx.font = "30px Arial"
    ctx.fillText(f"Your Score: {score}", canvas_width/2-90, 250)
    show_ranking()
    db.ref('ranking').push({'score': score})

# === 랭킹 불러오기 ===
def update_ranking(snapshot):
    global ranking_list
    data = snapshot.val()
    if data is None:
        ranking_list = []
    else:
        py_data = js_to_py(data)
        ranking_list = sorted([int(float(d['score'])) for d in py_data.values()], reverse=True)

db.ref('ranking').on('value', update_ranking)

# === 총알 생성 ===
import random
def spawn_bullet():
    x = random.randint(20, canvas_width-20)
    bullets.append({'x': x, 'y': -20, 'w': 10, 'h': 20})

# === 키 입력 ===
keys = {'left': False, 'right': False, 'up': False, 'down': False}
def key_down(ev):
    if ev.key in ['ArrowLeft','a']: keys['left']=True
    if ev.key in ['ArrowRight','d']: keys['right']=True
    if ev.key in ['ArrowUp','w']: keys['up']=True
    if ev.key in ['ArrowDown','s']: keys['down']=True

def key_up(ev):
    if ev.key in ['ArrowLeft','a']: keys['left']=False
    if ev.key in ['ArrowRight','d']: keys['right']=False
    if ev.key in ['ArrowUp','w']: keys['up']=False
    if ev.key in ['ArrowDown','s']: keys['down']=False

document.bind('keydown', key_down)
document.bind('keyup', key_up)

# === 모바일 터치 이동 ===
dragging = False
def touch_start(ev):
    global dragging
    dragging = True
def touch_move(ev):
    if dragging:
        player['x'] = ev.touches[0].clientX
        player['y'] = ev.touches[0].clientY
def touch_end(ev):
    global dragging
    dragging = False

document.bind('touchstart', touch_start)
document.bind('touchmove', touch_move)
document.bind('touchend', touch_end)

# === 충돌 체크 ===
def check_collision(p, b):
    return (p['x']-p['w']/2 < b['x']+b['w'] and
            p['x']+p['w']/2 > b['x'] and
            p['y']-p['h']/2 < b['y']+b['h'] and
            p['y']+p['h']/2 > b['y'])

# === 게임 루프 ===
def game_loop(timestamp=None):
    global score
    if game_over_flag:
        return

    ctx.clearRect(0,0,canvas_width,canvas_height)
    ctx.drawImage(bg_img, 0,0,canvas_width,canvas_height)

    # player 이동
    speed = 5
    if keys['left']: player['x'] -= speed
    if keys['right']: player['x'] += speed
    if keys['up']: player['y'] -= speed
    if keys['down']: player['y'] += speed

    # player 그리기
    ctx.drawImage(player_img, player['x']-player['w']/2, player['y']-player['h']/2, player['w'], player['h'])

    # 총알 이동 & 충돌 체크
    for b in bullets[:]:
        b['y'] += 5
        ctx.drawImage(bullet_img, b['x'], b['y'], b['w'], b['h'])
        if check_collision(player, b):
            game_over()
            return
        if b['y'] > canvas_height:
            bullets.remove(b)
            score += 1

    # 랜덤 총알 생성
    if random.randint(0,50)==0:
        spawn_bullet()

    window.requestAnimationFrame(game_loop)

window.requestAnimationFrame(game_loop)

</script>
</body>
</html>
