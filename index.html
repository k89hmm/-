<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Global Game with Ranking</title>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body onload="brython()">
    <h1 id="title">Global Game</h1>
    <button id="start">게임 시작</button>
    <span id="score">0</span>
    <canvas id="game" width="800" height="600" style="border:1px solid black;"></canvas>

    <script type="text/python">
from browser import document, window, html, timer
import random, json

# Firebase 설정
firebaseConfig = {
    'apiKey': "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
    'authDomain': "aaaa-85ddd.firebaseapp.com",
    'databaseURL': "https://aaaa-85ddd-default-rtdb.firebaseio.com",
    'projectId': "aaaa-85ddd",
    'storageBucket': "aaaa-85ddd.firebasestorage.app",
    'messagingSenderId': "947357162592",
    'appId': "1:947357162592:web:599896666a79b4b219f705",
    'measurementId': "G-KVHXK6GR39"
}
firebase = window.firebase
firebase.initializeApp(firebaseConfig)
db = firebase.database()

# 캔버스
canvas = document['game']
ctx = canvas.getContext('2d')
canvas_width = canvas.width
canvas_height = canvas.height

# 점수
score = 0
document['score'].text = str(score)

# 이미지 로딩
bg = window.Image.new()
player_img = window.Image.new()
bullet_img = window.Image.new()

player = {}
bullets = []

def on_player_load(ev):
    player['w'] = player_img.width / 2
    player['h'] = player_img.height / 2
    player['x'] = canvas_width / 2
    player['y'] = canvas_height / 2

player_img.onload = on_player_load
player_img.src = "player.png"
bg.src = "background.png"
bullet_img.src = "bullet.png"

# 키보드 이동
keys = {'up':False, 'down':False, 'left':False, 'right':False}
def keydown(ev):
    k = ev.code
    if k in ('ArrowUp','KeyW'): keys['up']=True
    if k in ('ArrowDown','KeyS'): keys['down']=True
    if k in ('ArrowLeft','KeyA'): keys['left']=True
    if k in ('ArrowRight','KeyD'): keys['right']=True
def keyup(ev):
    k = ev.code
    if k in ('ArrowUp','KeyW'): keys['up']=False
    if k in ('ArrowDown','KeyS'): keys['down']=False
    if k in ('ArrowLeft','KeyA'): keys['left']=False
    if k in ('ArrowRight','KeyD'): keys['right']=False

document.bind('keydown', keydown)
document.bind('keyup', keyup)

# 모바일 터치 이동
touch_start = None
def on_touch_start(ev):
    global touch_start
    touch_start = (ev.touches[0].clientX, ev.touches[0].clientY)
    ev.preventDefault()
def on_touch_move(ev):
    global touch_start
    if touch_start:
        dx = ev.touches[0].clientX - touch_start[0]
        dy = ev.touches[0].clientY - touch_start[1]
        player['x'] += dx
        player['y'] += dy
        touch_start = (ev.touches[0].clientX, ev.touches[0].clientY)
    ev.preventDefault()
def on_touch_end(ev):
    global touch_start
    touch_start = None
    ev.preventDefault()

canvas.bind('touchstart', on_touch_start)
canvas.bind('touchmove', on_touch_move)
canvas.bind('touchend', on_touch_end)

# 총알 생성
def spawn_bullet():
    x = random.randint(0, canvas_width)
    y = -bullet_img.height
    bullets.append({'x':x, 'y':y, 'w':bullet_img.width/2, 'h':bullet_img.height/2})

# 랭킹 처리
ranking = []

def load_ranking():
    def callback(snapshot):
        global ranking
        data = snapshot.val()
        if data:
            ranking = sorted([int(v['score']) for v in data.values()], reverse=True)[:5]
        else:
            ranking = []
    db.ref('/scores').on('value', callback)

load_ranking()

def save_score(score):
    db.ref('/scores').push({'score':score})

# 충돌 체크
def check_collision():
    for b in bullets:
        if (player['x'] - player['w']/2 < b['x'] + b['w'] and
            player['x'] + player['w']/2 > b['x'] and
            player['y'] - player['h']/2 < b['y'] + b['h'] and
            player['y'] + player['h']/2 > b['y']):
            return True
    return False

# 게임 오버
game_running = False
def game_over():
    global game_running
    game_running = False
    ctx.globalAlpha = 0.5
    ctx.fillStyle = "black"
    ctx.fillRect(0,0,canvas_width,canvas_height)
    ctx.globalAlpha = 1
    ctx.fillStyle = "white"
    ctx.font = "50px Arial"
    ctx.fillText("GAME OVER", 200, 150)
    ctx.font = "30px Arial"
    ctx.fillText(f"Your score: {score}", 250, 220)
    
    save_score(score)
    timer.set_timeout(load_ranking, 500)
    y = 300
    ctx.font = "25px Arial"
    for i, s in enumerate(ranking):
        ctx.fillText(f"{i+1}위: {s}", 300, y)
        y += 40
    if len(ranking)<5 or score < ranking[-1]:
        ctx.fillText("5등 안에 못 들었습니다", 250, y+20)

# 게임 루프
def game_loop(timestamp):
    global score
    if not game_running: return
    if keys['up']: player['y'] -= 5
    if keys['down']: player['y'] += 5
    if keys['left']: player['x'] -= 5
    if keys['right']: player['x'] += 5

    ctx.clearRect(0,0,canvas_width,canvas_height)
    ctx.drawImage(bg,0,0,canvas_width,canvas_height)
    ctx.drawImage(player_img, player['x']-player['w']/2, player['y']-player['h']/2, player['w'], player['h'])
    
    for b in bullets[:]:
        b['y'] += 5
        ctx.drawImage(bullet_img, b['x'], b['y'], b['w'], b['h'])
        if b['y'] > canvas_height:
            bullets.remove(b)
            score += 1
            document['score'].text = str(score)

    if random.random()<0.02:
        spawn_bullet()

    # 충돌 체크
    if check_collision():
        game_over()
        return

    window.requestAnimationFrame(game_loop)

# 게임 시작
def start(ev):
    global game_running, score, bullets
    game_running = True
    score = 0
    bullets.clear()
    document['score'].text = str(score)
    window.requestAnimationFrame(game_loop)

document['start'].bind('click', start)
    </script>
</body>
</html>
