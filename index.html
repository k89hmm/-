<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>좌형의 안민철 피하기</title>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        body {
            margin:0;
            overflow:hidden;
        }
        #ui {
            position:absolute;
            top:10px;
            left:10px;
            z-index:10;
            color:white;
            font-family:sans-serif;
        }
        canvas {
            display:block;
        }
    </style>
</head>
<body onload="brython()">
<div id="ui">
    <div id="title">좌형의 안민철 피하기</div>
    <button id="start">게임 시작</button>
    <span id="score">0</span>
</div>
<canvas id="game"></canvas>
<script type="text/python">

from browser import document, html, window

# Firebase 설정
firebaseConfig = {
    'apiKey': "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
    'authDomain': "aaaa-85ddd.firebaseapp.com",
    'databaseURL': "https://aaaa-85ddd-default-rtdb.firebaseio.com",
    'projectId': "aaaa-85ddd",
    'storageBucket': "aaaa-85ddd.firebasestorage.app",
    'messagingSenderId': "947357162592",
    'appId': "1:947357162592:web:599896666a79b4b219f705",
    'measurementId': "G-KVHXK6GR39"
}

firebase.initializeApp(firebaseConfig)
db = firebase.database()

canvas = document['game']
ctx = canvas.getContext('2d')

# 화면 크기 맞춤
def resize_canvas(ev=None):
    canvas.width = window.innerWidth
    canvas.height = window.innerHeight
window.bind('resize', resize_canvas)
resize_canvas()

canvas_width = canvas.width
canvas_height = canvas.height

# 이미지
bg = window.Image.new()
bg.src = "background.png"
player_img = window.Image.new()
player_img.src = "player.png"
bullet_img = window.Image.new()
bullet_img.src = "bullet.png"

player = {'x':0, 'y':0, 'w':0, 'h':0}
bullets = []
score = 0
game_over_flag = False
ranking = []

def on_player_load(ev):
    player['w'] = window.Math.floor(player_img.width / 2)
    player['h'] = window.Math.floor(player_img.height / 2)
    player['x'] = window.Math.floor(canvas_width/2 - player['w']/2)
    player['y'] = window.Math.floor(canvas_height/2 - player['h']/2)
player_img.onload = on_player_load

# 모바일 터치
touch = {'x':None, 'y':None}
def on_touch(ev):
    ev.preventDefault()
    touch['x'] = ev.touches[0].clientX
    touch['y'] = ev.touches[0].clientY
canvas.bind('touchmove', on_touch)

# 키보드
keys = {}
def keydown(ev):
    keys[ev.key] = True
def keyup(ev):
    keys[ev.key] = False
window.bind('keydown', keydown)
window.bind('keyup', keyup)

# 총알 생성
import random
def spawn_bullet():
    side = random.choice(['top','bottom','left','right'])
    if side == 'top':
        x = random.randint(0, canvas_width)
        y = -20
        dx = 0
        dy = random.randint(2,5)
    elif side == 'bottom':
        x = random.randint(0, canvas_width)
        y = canvas_height + 20
        dx = 0
        dy = -random.randint(2,5)
    elif side == 'left':
        x = -20
        y = random.randint(0, canvas_height)
        dx = random.randint(2,5)
        dy = 0
    else:
        x = canvas_width + 20
        y = random.randint(0, canvas_height)
        dx = -random.randint(2,5)
        dy = 0
    bullets.append({'x':x,'y':y,'dx':dx,'dy':dy,'w':bullet_img.width*3,'h':bullet_img.height*3})

# 게임 오버
def game_over():
    global game_over_flag
    game_over_flag = True
    ctx.fillStyle = 'rgba(0,0,0,0.5)'
    ctx.fillRect(0,0,canvas_width,canvas_height)
    ctx.fillStyle = 'white'
    ctx.font = '40px sans-serif'
    ctx.fillText('게임 오버', canvas_width/2-100, 100)
    ctx.fillText(f'점수: {score}', canvas_width/2-50, 160)

    # 랭킹 로드
    def callback(snapshot):
        global ranking
        data = snapshot.val()
        if data:
            ranking = sorted([int(d['score']) for d in window.Object.values(data)], reverse=True)
            ctx.font = '30px sans-serif'
            for i, val in enumerate(ranking[:5]):
                ctx.fillText(f'{i+1}위: {val}', canvas_width/2-50, 200 + i*40)
            if score < ranking[4] if len(ranking)>=5 else False:
                ctx.fillText('5등 안에 못 들었습니다', canvas_width/2-100, 400)
        else:
            ctx.fillText('랭킹 데이터 없음', canvas_width/2-100, 200)
    db.ref('scores').once('value', callback)

def update():
    global score
    # 플레이어 이동
    speed = 5
    if keys.get('ArrowUp') or keys.get('w'):
        player['y'] -= speed
    if keys.get('ArrowDown') or keys.get('s'):
        player['y'] += speed
    if keys.get('ArrowLeft') or keys.get('a'):
        player['x'] -= speed
    if keys.get('ArrowRight') or keys.get('d'):
        player['x'] += speed
    if touch['x'] is not None:
        player['x'] = touch['x'] - player['w']/2
        player['y'] = touch['y'] - player['h']/2

    # 총알 이동
    for b in bullets:
        b['x'] += b['dx']
        b['y'] += b['dy']
    # 점수 증가
    score += 1

def draw():
    ctx.clearRect(0,0,canvas_width,canvas_height)
    ctx.drawImage(bg,0,0,canvas_width,canvas_height)
    ctx.drawImage(player_img, player['x'], player['y'], player['w'], player['h'])
    for b in bullets:
        ctx.drawImage(bullet_img, b['x'], b['y'], b['w'], b['h'])
    document['score'].text = str(score)

def game_loop(timestamp=None):
    if not game_over_flag:
        update()
        draw()
        window.requestAnimationFrame(game_loop)

# 시작 버튼
def start(ev):
    global score, bullets, game_over_flag
    score = 0
    bullets = []
    game_over_flag = False
    player['x'] = window.Math.floor(canvas_width/2 - player['w']/2)
    player['y'] = window.Math.floor(canvas_height/2 - player['h']/2)
    window.requestAnimationFrame(game_loop)
document['start'].bind('click', start)

# 주기적 총알 생성
def bullet_spawn_loop():
    if not game_over_flag:
        spawn_bullet()
        window.setTimeout(bullet_spawn_loop, 1000)
bullet_spawn_loop()

</script>
</body>
</html>
