<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Space Game with Firebase Ranking</title>

<!-- ‚úÖ Brython ÏµúÏã† Î≤ÑÏ†Ñ + ÌëúÏ§Ä ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython_stdlib.js"></script>

<!-- ‚úÖ Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, push, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // ‚öôÔ∏è ÎÑ§ Firebase ÏÑ§Ï†ïÍ∞í Ïó¨Í∏∞Ïóê ÎÑ£Í∏∞
  const firebaseConfig = {
    'apiKey': "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
    'authDomain': "aaaa-85ddd.firebaseapp.com",
    'databaseURL': "https://aaaa-85ddd-default-rtdb.firebaseio.com",
    'projectId': "aaaa-85ddd",
    'storageBucket': "aaaa-85ddd.firebasestorage.app",
    'messagingSenderId': "947357162592",
    'appId': "1:947357162592:web:599896666a79b4b219f705",
    'measurementId': "G-KVHXK6GR39"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  window.db = db; // BrythonÏóêÏÑú Ï†ëÍ∑ºÌï† Ïàò ÏûàÍ≤å Ï†ÑÏó≠ÏúºÎ°ú ÎÖ∏Ï∂ú
  window.db_ref = ref;
  window.db_push = push;
  window.db_get = get;
  window.db_child = child;
</script>

<style>
  body {
    margin: 0;
    overflow: hidden;
    background: black;
  }
  #gameCanvas {
    display: block;
    margin: auto;
    background: url('background.png') no-repeat center center;
    background-size: cover;
  }
</style>
</head>

<body onload="brython()">
<canvas id="gameCanvas" width="480" height="640"></canvas>

<script type="text/python">
from browser import document, html, window, timer
import random, math

canvas = document["gameCanvas"]
ctx = canvas.getContext("2d")

bg = html.IMG(src="background.png")
player_img = html.IMG(src="player.png")
bullet_img = html.IMG(src="bullet.png")

player = {"x": 220, "y": 580}
bullets = []
score = 0
game_over = False
ranking = []

# üî• Firebase Ïó∞Í≤∞
db = window.db
ref = window.db_ref
push = window.db_push
get = window.db_get
child = window.db_child

def update_rankings():
    global ranking
    promise = get(child(ref(db), "scores"))
    def callback(snapshot):
        global ranking
        data = snapshot.val()
        if data:
            scores = [int(v["score"]) for v in data.values()]
            ranking = sorted(scores, reverse=True)[:5]
        else:
            ranking = []
    promise.then(callback)

update_rankings()

def add_score(new_score):
    push(ref(db, "scores"), {"score": new_score})
    update_rankings()

def create_bullet():
    side = random.choice(["left", "right", "top"])
    if side == "left":
        x, y, dx, dy = -10, random.randint(0, 640), random.uniform(1, 2), 0
    elif side == "right":
        x, y, dx, dy = 490, random.randint(0, 640), -random.uniform(1, 2), 0
    else:
        x, y, dx, dy = random.randint(0, 480), -10, 0, random.uniform(1, 2)
    bullets.append({"x": x, "y": y, "dx": dx, "dy": dy})

def update():
    global score, game_over

    if game_over:
        ctx.fillStyle = "rgba(0,0,0,0.5)"
        ctx.fillRect(0, 0, canvas.width, canvas.height)
        ctx.fillStyle = "white"
        ctx.font = "30px Arial"
        ctx.fillText("GAME OVER", 150, 300)
        ctx.font = "20px Arial"
        ctx.fillText(f"Your Score: {score}", 180, 340)
        ctx.fillText("Top Rankings:", 160, 380)
        y = 410
        for i, s in enumerate(ranking):
            ctx.fillText(f"{i+1}. {s}", 200, y)
            y += 25
        return

    ctx.clearRect(0, 0, 480, 640)
    ctx.drawImage(bg, 0, 0, 480, 640)
    ctx.drawImage(player_img, player["x"], player["y"], 40, 40)

    for b in bullets:
        b["x"] += b["dx"]
        b["y"] += b["dy"]
        ctx.drawImage(bullet_img, b["x"], b["y"], 10, 10)

    for b in bullets:
        if abs(b["x"] - player["x"]) < 20 and abs(b["y"] - player["y"]) < 20:
            game_over = True
            add_score(score)
            return

    score += 1
    ctx.fillStyle = "white"
    ctx.font = "16px Arial"
    ctx.fillText(f"Score: {score}", 10, 20)

def move_player(ev):
    key = ev.key
    if key == "ArrowLeft" and player["x"] > 0:
        player["x"] -= 10
    elif key == "ArrowRight" and player["x"] < 440:
        player["x"] += 10
    elif key == "ArrowUp" and player["y"] > 0:
        player["y"] -= 10
    elif key == "ArrowDown" and player["y"] < 600:
        player["y"] += 10

document.bind("keydown", move_player)
timer.set_interval(create_bullet, 1000)
timer.set_interval(update, 50)
</script>
</body>
</html>
