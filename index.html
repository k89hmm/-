<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>좌형의 안민철 피하기</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: white; text-align: center; z-index: 10; }
        #score { position: absolute; top: 10px; right: 10px; color: white; font-size: 20px; }
        canvas { display: block; margin: auto; background: #000; }
    </style>
    <!-- Brython -->
    <script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython_stdlib.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body onload="brython()">
<div id="ui">
    <h1>좌형의 안민철 피하기</h1>
    <button id="start-btn">게임 시작</button>
</div>
<div id="score">점수: 0</div>
<canvas id="game"></canvas>

<script type="text/python">
from browser import document, html, window, timer
import random

# --- Canvas ---
canvas = document["game"]
ctx = canvas.getContext("2d")
canvas_width = window.innerWidth
canvas_height = window.innerHeight
canvas.width = canvas_width
canvas.height = canvas_height

# --- Images ---
bg = html.IMG()
bg.src = "background.png"

player_img = html.IMG()
player_img.src = "player.png"

bullet_img = html.IMG()
bullet_img.src = "bullet.png"

# --- Game State ---
player = {'x': canvas_width//2, 'y': canvas_height//2, 'w':50, 'h':50}
bullets = []
score = 0
game_running = False
game_over_flag = False
ranking = []

# --- Player size after load ---
def on_player_load(ev):
    player['w'] = int(player_img.width / 2)
    player['h'] = int(player_img.height / 2)
    player['x'] = canvas_width // 2
    player['y'] = canvas_height // 2
player_img.bind('load', on_player_load)

# --- Input ---
keys = {'up':False, 'down':False, 'left':False, 'right':False}

def keydown(ev):
    if ev.key in ("ArrowUp","w","W"): keys['up']=True
    if ev.key in ("ArrowDown","s","S"): keys['down']=True
    if ev.key in ("ArrowLeft","a","A"): keys['left']=True
    if ev.key in ("ArrowRight","d","D"): keys['right']=True
    ev.preventDefault()

def keyup(ev):
    if ev.key in ("ArrowUp","w","W"): keys['up']=False
    if ev.key in ("ArrowDown","s","S"): keys['down']=False
    if ev.key in ("ArrowLeft","a","A"): keys['left']=False
    if ev.key in ("ArrowRight","d","D"): keys['right']=False
    ev.preventDefault()

document.bind("keydown", keydown)
document.bind("keyup", keyup)

# --- Touch input ---
touching = False
def touch_start(ev):
    global touching
    touching = True
    ev.preventDefault()
def touch_move(ev):
    if touching:
        player['x'] = int(ev.touches[0].clientX)
        player['y'] = int(ev.touches[0].clientY)
    ev.preventDefault()
def touch_end(ev):
    global touching
    touching = False
    ev.preventDefault()

canvas.bind("touchstart", touch_start)
canvas.bind("touchmove", touch_move)
canvas.bind("touchend", touch_end)

# --- Bullets ---
def spawn_bullet():
    side = random.choice(["top","bottom","left","right"])
    if side=="top":
        x = random.randint(0, canvas_width)
        y = -bullet_img.height
        dx,dy = 0, random.randint(3,6)
    elif side=="bottom":
        x = random.randint(0, canvas_width)
        y = canvas_height + bullet_img.height
        dx,dy = 0, -random.randint(3,6)
    elif side=="left":
        x = -bullet_img.width
        y = random.randint(0, canvas_height)
        dx,dy = random.randint(3,6), 0
    else: # right
        x = canvas_width + bullet_img.width
        y = random.randint(0, canvas_height)
        dx,dy = -random.randint(3,6), 0
    bullets.append({'x':x,'y':y,'dx':dx,'dy':dy})

# --- Firebase Config ---
firebaseConfig = {
    "apiKey": "YOUR_API_KEY",
    "authDomain": "YOUR_PROJECT.firebaseapp.com",
    "databaseURL": "https://YOUR_PROJECT.firebaseio.com",
    "projectId": "YOUR_PROJECT",
    "storageBucket": "YOUR_PROJECT.appspot.com",
    "messagingSenderId": "SENDER_ID",
    "appId": "APP_ID",
}

firebase_app = window.firebase.initializeApp(firebaseConfig)
firebase_db = window.firebase.database()

# --- Ranking ---
def load_ranking():
    global ranking
    def callback(snapshot):
        data = snapshot.val()
        ranking_list = []
        if data:
            for k in window.Object.keys(data):
                v = data[k]
                ranking_list.append({"name":v["name"], "score":int(v["score"])})
            ranking_list.sort(key=lambda x:x["score"], reverse=True)
            ranking[:] = ranking_list[:5]
        else:
            ranking.clear()
    firebase_db.ref("ranking").on("value", callback)

def save_score(name, score_value):
    firebase_db.ref("ranking").push({"name":name, "score":score_value})

# --- Game Over ---
def game_over():
    global game_running, game_over_flag
    game_running = False
    game_over_flag = True
    ctx.fillStyle = "rgba(0,0,0,0.5)"
    ctx.fillRect(0,0,canvas_width,canvas_height)
    ctx.fillStyle = "white"
    ctx.font = "50px sans-serif"
    ctx.fillText("게임 오버", canvas_width//2 - 150, canvas_height//2 - 60)
    ctx.font = "30px sans-serif"
    ctx.fillText(f"점수: {score}", canvas_width//2 - 50, canvas_height//2)
    # Top 5 ranking
    ctx.font = "25px sans-serif"
    for i,r in enumerate(ranking):
        ctx.fillText(f"{i+1}. {r['name']} : {r['score']}", canvas_width//2 - 70, canvas_height//2 + 40 + i*30)
    if ranking and score < ranking[-1]['score']:
        ctx.fillText("5등 안에 못 들었습니다", canvas_width//2 - 120, canvas_height//2 + 200)

# --- Draw ---
def draw():
    ctx.clearRect(0,0,canvas_width,canvas_height)
    ctx.drawImage(bg,0,0,canvas_width,canvas_height)
    ctx.drawImage(player_img, player['x']-player['w']//2, player['y']-player['h']//2, player['w'], player['h'])
    for b in bullets:
        ctx.drawImage(bullet_img, b['x'], b['y'], bullet_img.width*3, bullet_img.height*3)

# --- Update ---
def update(dt):
    global score
    if not game_running: return
    speed = 5
    if keys['up']: player['y'] -= speed
    if keys['down']: player['y'] += speed
    if keys['left']: player['x'] -= speed
    if keys['right']: player['x'] += speed

    for b in bullets:
        b['x'] += b['dx']
        b['y'] += b['dy']
        if abs(b['x']-player['x']) < player['w']*0.2 and abs(b['y']-player['y']) < player['h']*0.5:
            game_over()
    bullets[:] = [b for b in bullets if -50 < b['x'] < canvas_width+50 and -50 < b['y'] < canvas_height+50]
    score += 1
    document["score"].text = f"점수: {score}"

# --- Game Loop ---
def game_loop(ts):
    update(16)
    draw()
    if game_running:
        window.requestAnimationFrame(game_loop)

# --- Start Game ---
def start_game(ev):
    global game_running, bullets, score, game_over_flag
    game_running = True
    game_over_flag = False
    bullets.clear()
    score = 0
    player['x'] = canvas_width//2
    player['y'] = canvas_height//2
    window.requestAnimationFrame(game_loop)

document["start-btn"].bind("click", start_game)

# --- Spawn bullets ---
def spawn_loop():
    if game_running:
        spawn_bullet()
    timer.set_timeout(spawn_loop, 500)

spawn_loop()
load_ranking()

</script>
</body>
</html>
