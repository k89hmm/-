<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>좌형의 안민철 피하기</title>
<style>
body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  margin:20px;
  background:#111;
  color:#eee;
}
#controls {
  display:flex;
  gap:8px;
  align-items:center;
}
button {padding:8px 12px;border-radius:6px;border:none;background:#2b6df6;color:white;cursor:pointer;}
#score {font-weight:700;}
canvas {border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,0.6);}
</style>
<script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython_stdlib.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body onload="brython()">

<h1>좌형의 안민철 피하기</h1>
<div id="controls">
  <button id="start">시작</button>
  <div id="score">점수: 0</div>
</div>
<canvas id="game" width="480" height="640"></canvas>

<script type="text/python3">
from browser import document, html, timer, window
import math, random, json

# ===== Firebase 설정 =====
firebaseConfig = {
  apiKey: "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
  authDomain: "aaaa-85ddd.firebaseapp.com",
  databaseURL: "https://aaaa-85ddd-default-rtdb.firebaseio.com",
  projectId: "aaaa-85ddd",
  storageBucket: "aaaa-85ddd.firebasestorage.app",
  messagingSenderId: "947357162592",
  appId: "1:947357162592:web:599896666a79b4b219f705",
  measurementId: "G-KVHXK6GR39"
}

firebase = window.firebase
app = firebase.initializeApp(firebaseConfig)
db = firebase.database()

# ===== 게임 설정 =====
CANVAS = document['game']
ctx = CANVAS.getContext('2d')
W, H = CANVAS.width, CANVAS.height

player = {'x': W/2, 'y': H/2, 'w': 50, 'h': 50, 'speed':6}
bullets = []
spawn_interval = 700
last_spawn = 0
running = False
score = 0
keys = {'left': False, 'right': False, 'up': False, 'down': False}
player_loaded = False
bullet_img_loaded = False

# ===== 이미지 =====
player_img = html.IMG()
player_img.src = 'player.png'

bullet_img = html.IMG()
bullet_img.src = 'bullet.png'

def on_player_load(ev):
    global player_loaded
    player_loaded = True
player_img.bind('load', on_player_load)

def on_bullet_load(ev):
    global bullet_img_loaded
    bullet_img_loaded = True
bullet_img.bind('load', on_bullet_load)

# ===== 총알 생성 =====
def spawn_bullet():
    edge = random.choice(['top','bottom','left','right'])
    size = random.uniform(10, 30)
    speed = random.uniform(2.0,4.0)
    if edge=='top':
        bullets.append({'x': random.uniform(0,W), 'y': -size, 'vx':0, 'vy':speed, 'r':size})
    elif edge=='bottom':
        bullets.append({'x': random.uniform(0,W), 'y': H+size, 'vx':0, 'vy':-speed, 'r':size})
    elif edge=='left':
        bullets.append({'x': -size, 'y': random.uniform(0,H), 'vx':speed, 'vy':0, 'r':size})
    else: # right
        bullets.append({'x': W+size, 'y': random.uniform(0,H), 'vx':-speed, 'vy':0, 'r':size})

# ===== 업데이트 =====
def update(dt):
    global last_spawn, score, running
    if not running:
        return

    last_spawn += dt
    if last_spawn>=spawn_interval:
        last_spawn=0
        spawn_bullet()

    # 플레이어 이동
    if keys['left']: player['x']-=player['speed']
    if keys['right']: player['x']+=player['speed']
    if keys['up']: player['y']-=player['speed']
    if keys['down']: player['y']+=player['speed']
    player['x']=max(player['w']/2,min(W-player['w']/2,player['x']))
    player['y']=max(player['h']/2,min(H-player['h']/2,player['y']))

    # 총알 이동 및 점수
    for b in list(bullets):
        b['x']+=b['vx']
        b['y']+=b['vy']
        if b['x']<-50 or b['x']>W+50 or b['y']<-50 or b['y']>H+50:
            bullets.remove(b)
            score+=1

    # 충돌체크
    for b in bullets:
        dx = abs(b['x']-player['x'])
        dy = abs(b['y']-player['y'])
        if dx < (b['r']/2 + player['w']/4) and dy < (b['r']/2 + player['h']/2):
            running=False
            game_over()
            break

# ===== 그리기 =====
def draw():
    ctx.clearRect(0,0,W,H)
    # 배경
    ctx.fillStyle='#111'
    ctx.fillRect(0,0,W,H)
    # 플레이어
    if player_loaded:
        ctx.drawImage(player_img, player['x']-player['w']/2, player['y']-player['h']/2, player['w'], player['h'])
    else:
        ctx.fillStyle='#66ff99'
        ctx.fillRect(player['x']-player['w']/2, player['y']-player['h']/2, player['w'], player['h'])
    # 총알
    for b in bullets:
        if bullet_img_loaded:
            ctx.drawImage(bullet_img,b['x']-b['r'],b['y']-b['r'],b['r']*2,b['r']*2)
        else:
            ctx.fillStyle='#ff6b6b'
            ctx.beginPath()
            ctx.arc(b['x'],b['y'],b['r'],0,2*math.pi)
            ctx.fill()
    document['score'].text=f"점수: {score}"

def game_loop():
    update(16)
    draw()

# ===== 키보드 =====
def on_keydown(ev):
    if ev.key in ('ArrowLeft','a'): keys['left']=True
    if ev.key in ('ArrowRight','d'): keys['right']=True
    if ev.key in ('ArrowUp','w'): keys['up']=True
    if ev.key in ('ArrowDown','s'): keys['down']=True

def on_keyup(ev):
    if ev.key in ('ArrowLeft','a'): keys['left']=False
    if ev.key in ('ArrowRight','d'): keys['right']=False
    if ev.key in ('ArrowUp','w'): keys['up']=False
    if ev.key in ('ArrowDown','s'): keys['down']=False

# ===== 게임 시작 =====
def start_game(ev=None):
    global running, bullets, score, player
    bullets=[]
    score=0
    player['x']=W/2
    player['y']=H/2
    running=True

document.bind('keydown',on_keydown)
document.bind('keyup',on_keyup)
document['start'].bind('click',start_game)

# ===== 게임오버 =====
def game_over():
    ctx.fillStyle='rgba(0,0,0,0.5)'
    ctx.fillRect(0,0,W,H)
    ctx.fillStyle='#fff'
    ctx.font='36px sans-serif'
    ctx.textAlign='center'
    ctx.fillText('게임 오버', W/2, H/2-60)
    ctx.font='24px sans-serif'
    ctx.fillText(f'점수: {score}', W/2, H/2-20)

    # 랭킹 저장
    name = window.prompt("플레이어 이름을 입력하세요 (5글자 이내):","익명")
    if not name: name="익명"
    name = str(name)[:5]

    ref = db.ref('ranking')
    ref.push({"name":name,"score":score})

    # 상위 5 랭킹 불러오기
    def callback(snapshot):
        data = snapshot.val()
        if data:
            items=list(data.values())
            items.sort(key=lambda x:-x['score'])
            top5 = items[:5]
            y = H/2+20
            for idx, entry in enumerate(top5):
                ctx.fillText(f"{idx+1}. {entry['name']} : {entry['score']}", W/2, y)
                y+=30
            if score<top5[-1]['score']:
                ctx.fillText("5등 안에 못 들었습니다", W/2, y)
    ref.get().then(callback)

# ===== 루프 =====
def loop(ts):
    game_loop()
    timer.request_animation_frame(loop)

timer.request_animation_frame(loop)
</script>
</body>
</html>
