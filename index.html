<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>좌형의 안민철 피하기</title>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body onload="brython()">
    <h1>좌형의 안민철 피하기</h1>
    <button id="start-btn">게임 시작</button>
    <span id="score">점수: 0</span>
    <canvas id="game" width="800" height="600" style="border:1px solid #000"></canvas>

<script type="text/python">
from browser import document, window, html
import math, json

# ------------------------------
# Firebase 설정 (본인 프로젝트로 수정)
firebaseConfig = {
    'apiKey': "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
    'authDomain': "aaaa-85ddd.firebaseapp.com",
    'databaseURL': "https://aaaa-85ddd-default-rtdb.firebaseio.com",
    'projectId': "aaaa-85ddd",
    'storageBucket': "aaaa-85ddd.firebasestorage.app",
    'messagingSenderId': "947357162592",
    'appId': "1:947357162592:web:599896666a79b4b219f705",
    'measurementId': "G-KVHXK6GR39"
}
window.firebase.initializeApp(firebaseConfig)
db = window.firebase.database()
# ------------------------------

canvas = document["game"]
ctx = canvas.getContext("2d")

canvas_width = canvas.width
canvas_height = canvas.height

# 이미지 로드
bg = window.Image.new()
bg.src = "background.png"

player_img = window.Image.new()
player_img.src = "player.png"

bullet_img = window.Image.new()
bullet_img.src = "bullet.png"

player = {"x":0, "y":0, "w":0, "h":0}
bullets = []
score = 0
game_running = False

ranking = []

def on_player_load(ev):
    player["w"] = int(player_img.width / 2)
    player["h"] = int(player_img.height / 2)
    player["x"] = canvas_width // 2
    player["y"] = canvas_height // 2

player_img.bind("load", on_player_load)

# ------------------------------
# 게임 시작
def start_game(ev):
    global game_running, score, bullets
    game_running = True
    score = 0
    bullets = []
    player["x"] = canvas_width // 2
    player["y"] = canvas_height // 2
    window.requestAnimationFrame(game_loop)

document["start-btn"].bind("click", start_game)

# ------------------------------
# 키보드 이동
keys = {"ArrowUp":False, "ArrowDown":False, "ArrowLeft":False, "ArrowRight":False,
        "w":False, "a":False, "s":False, "d":False}

def key_down(ev):
    if ev.key in keys:
        keys[ev.key] = True
        ev.preventDefault()

def key_up(ev):
    if ev.key in keys:
        keys[ev.key] = False
        ev.preventDefault()

document.bind("keydown", key_down)
document.bind("keyup", key_up)

# ------------------------------
# 모바일 터치 이동
touch_active = False

def touch_start(ev):
    global touch_active
    touch_active = True
    ev.preventDefault()

def touch_move(ev):
    if touch_active:
        t = ev.touches[0]
        player["x"] = t.clientX - canvas.offsetLeft
        player["y"] = t.clientY - canvas.offsetTop
        ev.preventDefault()

def touch_end(ev):
    global touch_active
    touch_active = False
    ev.preventDefault()

canvas.bind("touchstart", touch_start)
canvas.bind("touchmove", touch_move)
canvas.bind("touchend", touch_end)

# ------------------------------
# 총알 생성
import random

def spawn_bullet():
    side = random.choice(["top","bottom","left","right"])
    if side == "top":
        x = random.randint(0, canvas_width)
        y = -20
        dx = 0
        dy = 2
    elif side == "bottom":
        x = random.randint(0, canvas_width)
        y = canvas_height + 20
        dx = 0
        dy = -2
    elif side == "left":
        x = -20
        y = random.randint(0, canvas_height)
        dx = 2
        dy = 0
    else: # right
        x = canvas_width + 20
        y = random.randint(0, canvas_height)
        dx = -2
        dy = 0
    bullets.append({"x":x, "y":y, "dx":dx, "dy":dy, "w":bullet_img.width//2, "h":bullet_img.height//2})

# ------------------------------
# 게임 오버 처리
def game_over():
    global game_running
    game_running = False
    ctx.globalAlpha = 0.5
    ctx.drawImage(bg, 0, 0, canvas_width, canvas_height)
    ctx.globalAlpha = 1.0
    ctx.fillStyle = "red"
    ctx.font = "48px Arial"
    ctx.fillText("게임 오버", 200, 100)
    ctx.fillText(f"점수: {score}", 200, 160)
    load_ranking()

# ------------------------------
# 랭킹 로드
def load_ranking():
    global ranking
    def callback(snapshot):
        data = snapshot.val()
        if data:
            jsobj = window.JSON.parse(window.JSON.stringify(data))
            ranking = sorted([int(d["score"]) for d in jsobj.values()], reverse=True)[:5]
        else:
            ranking = []
        show_ranking()
    db.ref("ranking").on("value", callback)

def show_ranking():
    ctx.fillStyle = "black"
    ctx.font = "24px Arial"
    y = 220
    for i, s in enumerate(ranking):
        ctx.fillText(f"{i+1}위: {s}", 200, y)
        y += 30
    if len(ranking) < 5 or score < ranking[-1]:
        ctx.fillText("5등 안에 못 들었습니다", 200, y)

# ------------------------------
# 게임 루프
def game_loop(timestamp=None):
    global score
    if not game_running:
        return

    ctx.clearRect(0, 0, canvas_width, canvas_height)
    ctx.drawImage(bg, 0, 0, canvas_width, canvas_height)

    # 키보드 이동
    speed = 5
    if keys["ArrowUp"] or keys["w"]:
        player["y"] -= speed
    if keys["ArrowDown"] or keys["s"]:
        player["y"] += speed
    if keys["ArrowLeft"] or keys["a"]:
        player["x"] -= speed
    if keys["ArrowRight"] or keys["d"]:
        player["x"] += speed

    # 화면 경계 체크
    player["x"] = max(0, min(canvas_width - player["w"], player["x"]))
    player["y"] = max(0, min(canvas_height - player["h"], player["y"]))

    # 총알 이동
    if random.random() < 0.02:
        spawn_bullet()

    new_bullets = []
    for b in bullets:
        b["x"] += b["dx"]
        b["y"] += b["dy"]
        ctx.drawImage(bullet_img, b["x"], b["y"], b["w"], b["h"])
        # 충돌 체크
        if (player["x"] < b["x"]+b["w"]*0.2 and player["x"]+player["w"]*0.5 > b["x"] and
            player["y"] < b["y"]+b["h"]*0.5 and player["y"]+player["h"]*0.5 > b["y"]):
            game_over()
            return
        # 화면 밖 총알 제거
        if 0 <= b["x"] <= canvas_width and 0 <= b["y"] <= canvas_height:
            new_bullets.append(b)
    bullets[:] = new_bullets

    score += 1
    document["score"].text = f"점수: {score}"

    window.requestAnimationFrame(game_loop)

</script>
</body>
</html>
