<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ì¢Œí˜•ì˜ ì•ˆë¯¼ì²  í”¼í•˜ê¸°</title>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
    body { margin: 0; text-align: center; background: #000; overflow: hidden; }
    #gameCanvas { display: block; margin: 20px auto; background: #000; }
    #ui { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); color: white; text-align: center; }
    #score { font-size: 20px; margin-top: 5px; }
    #gameOverOverlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5); color: white; font-size: 24px;
        text-align: center; justify-content: center; align-items: center; flex-direction: column;
    }
</style>
</head>
<body onload="brython()">
<div id="ui">
    <h1>ì¢Œí˜•ì˜ ì•ˆë¯¼ì²  í”¼í•˜ê¸°</h1>
    <button id="startButton">ê²Œì„ ì‹œì‘</button>
    <div id="score">ì ìˆ˜: 0</div>
</div>
<canvas id="gameCanvas" width="800" height="600"></canvas>

<!-- ê²Œì„ ì˜¤ë²„ í™”ë©´ -->
<div id="gameOverOverlay">
    <div id="gameOverText">ê²Œì„ ì˜¤ë²„</div>
    <div id="finalScore"></div>
    <div id="ranking"></div>
</div>

<script type="text/python">
from browser import document, html, window, aio
import random, math, json

# ===== Firebase ì—°ê²° =====
firebaseConfig = {
    'apiKey': "AIzaSyA4uk5Iv6UPOX_P2d-tKkZd1p9E8m2rV44",
    'authDomain': "aaaa-85ddd.firebaseapp.com",
    'databaseURL': "https://aaaa-85ddd-default-rtdb.firebaseio.com",
    'projectId': "aaaa-85ddd",
    'storageBucket': "aaaa-85ddd.firebasestorage.app",
    'messagingSenderId': "947357162592",
    'appId': "1:947357162592:web:599896666a79b4b219f705",
    'measurementId': "G-KVHXK6GR39"
}
window.firebase.initializeApp(firebaseConfig)
db = window.firebase.database()

# ===== ê¸°ë³¸ ì„¤ì • =====
canvas = document["gameCanvas"]
ctx = canvas.getContext("2d")

width, height = canvas.width, canvas.height

player_img = window.Image.new()
player_img.src = "player.png"
bullet_img = window.Image.new()
bullet_img.src = "bullet.png"
bg_img = window.Image.new()
bg_img.src = "background.png"

player = {"x": width/2, "y": height/2, "size": 40}
bullets = []
score = 0
running = False
keys = set()
ranking_data = []

# ===== ì´ì•Œ ìŠ¤í° =====
def spawn_bullet():
    side = random.choice(["left", "right", "top", "bottom"])
    speed = random.uniform(2, 5)
    if side == "left":
        x, y, dx, dy = -10, random.randint(0, height), speed, 0
    elif side == "right":
        x, y, dx, dy = width+10, random.randint(0, height), -speed, 0
    elif side == "top":
        x, y, dx, dy = random.randint(0, width), -10, 0, speed
    else:
        x, y, dx, dy = random.randint(0, width), height+10, 0, -speed
    bullets.append({"x": x, "y": y, "dx": dx, "dy": dy})

# ===== ê²Œì„ ë£¨í”„ =====
def update():
    global score, running

    # í”Œë ˆì´ì–´ ì´ë™
    speed = 5
    if "ArrowLeft" in keys: player["x"] -= speed
    if "ArrowRight" in keys: player["x"] += speed
    if "ArrowUp" in keys: player["y"] -= speed
    if "ArrowDown" in keys: player["y"] += speed

    # í™”ë©´ ê²½ê³„
    player["x"] = max(player["size"]/2, min(width-player["size"]/2, player["x"]))
    player["y"] = max(player["size"]/2, min(height-player["size"]/2, player["y"]))

    # ì´ì•Œ ì´ë™
    for b in bullets:
        b["x"] += b["dx"]
        b["y"] += b["dy"]

    # ì¶©ëŒ íŒì •
    for b in bullets:
        dist = math.hypot(b["x"]-player["x"], b["y"]-player["y"])
        if dist < player["size"]*0.4:
            game_over()
            return

    score += 1
    document["score"].text = f"ì ìˆ˜: {score}"

def draw():
    ctx.clearRect(0,0,width,height)
    ctx.drawImage(bg_img,0,0,width,height)
    ctx.drawImage(player_img, player["x"]-player["size"]/2, player["y"]-player["size"]/2, player["size"], player["size"])
    for b in bullets:
        ctx.drawImage(bullet_img, b["x"]-15, b["y"]-15, 30, 30)

def game_loop():
    if running:
        if random.random() < 0.03:
            spawn_bullet()
        update()
        draw()

# ===== í‚¤ë³´ë“œ ì…ë ¥ =====
def keydown(e): keys.add(e.key)
def keyup(e): keys.discard(e.key)
document.bind("keydown", keydown)
document.bind("keyup", keyup)

# ===== ëª¨ë°”ì¼ í„°ì¹˜ ì´ë™ =====
def on_touch(e):
    t = e.touches[0]
    rect = canvas.getBoundingClientRect()
    player["x"] = t.clientX - rect.left
    player["y"] = t.clientY - rect.top
    e.preventDefault()
canvas.bind("touchmove", on_touch)

# ===== ê²Œì„ ì‹œì‘ =====
def start_game(e):
    global score, running, bullets
    score = 0
    bullets = []
    player["x"], player["y"] = width/2, height/2
    running = True
    document["gameOverOverlay"].style.display = "none"
document["startButton"].bind("click", start_game)

# ===== ê²Œì„ ì˜¤ë²„ =====
def game_over():
    global running
    running = False
    document["gameOverOverlay"].style.display = "flex"
    document["finalScore"].text = f"ë‹¹ì‹ ì˜ ì ìˆ˜: {score}"

    save_score(score)
    show_ranking()

# ===== ì ìˆ˜ ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸° =====
def save_score(s):
    new_entry = {"name": "í”Œë ˆì´ì–´", "score": s}
    db.ref("ranking").push(new_entry)

def show_ranking():
    def callback(snapshot):
        data = snapshot.val()
        if not data:
            document["ranking"].text = "ë­í‚¹ ë°ì´í„° ì—†ìŒ"
            return
        records = [{"name": v["name"], "score": int(v["score"])} for v in data.values()]
        top5 = sorted(records, key=lambda x: x["score"], reverse=True)[:5]

        html_str = "<h3>ğŸ† ìƒìœ„ 5ëª…</h3>"
        for i, r in enumerate(top5, 1):
            html_str += f"{i}ë“±: {r['name']} ({r['score']}ì )<br>"
        if score < top5[-1]["score"]:
            html_str += "<br>5ë“± ì•ˆì— ëª» ë“¤ì—ˆìŠµë‹ˆë‹¤ ğŸ˜¢"
        document["ranking"].html = html_str

    db.ref("ranking").once("value").then(callback)

# ===== ë£¨í”„ ì‹œì‘ =====
window.setInterval(game_loop, 30)
</script>
</body>
</html>
