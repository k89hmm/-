<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>좌형의 안민철 피하기</title>
<style>
  body { margin:0; overflow:hidden; font-family: Arial, sans-serif; }
  #ui { position: absolute; top: 10px; left: 10px; z-index: 100; }
  #start-btn { font-size: 20px; padding: 5px 10px; }
  #score { font-size: 20px; margin-left: 20px; display:inline-block; }
  #game-over { position:absolute; top: 50px; left:50%; transform:translateX(-50%); color:white; font-size:36px; display:none; text-align:center; }
</style>
<script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/brython@3.12.1/brython_stdlib.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  window.firebaseApp = initializeApp({
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
      measurementId: "YOUR_MEASUREMENT_ID"
  });

  window.db = getDatabase(window.firebaseApp);
</script>
</head>
<body onload="brython()">
<div id="ui">
  <button id="start-btn">게임 시작</button>
  <div id="score">점수: 0</div>
</div>
<div id="game-over">
  <div id="game-over-msg">게임 오버</div>
  <div id="final-score"></div>
  <div id="ranking"></div>
</div>
<script type="text/python">
from browser import document, html, window, timer

# 게임 설정
canvas_width = 800
canvas_height = 600
stage = html.CANVAS(width=canvas_width, height=canvas_height, style={'border':'1px solid black'})
document <= stage
ctx = stage.getContext('2d')

# 이미지 로드
bg = html.IMG()
bg.src = "background.png"
player_img = html.IMG()
player_img.src = "player.png"
bullet_img = html.IMG()
bullet_img.src = "bullet.png"

player = {'x':canvas_width//2, 'y':canvas_height//2, 'w':player_img.width//2, 'h':player_img.height//2}
bullets = []
score = 0
game_running = False
ranking = []

db = window.db
ranking_ref = window.firebase.database().ref('/ranking')

# Firebase에서 top5 랭킹 가져오기
def load_ranking(*args):
    snapshot = args[0]
    data = snapshot.val()
    global ranking
    ranking = []
    if data:
        import json
        py_data = window.JSON.parse(window.JSON.stringify(data))
        ranking = sorted([int(d['score']) for d in py_data.values()], reverse=True)[:5]
ranking_ref.on('value', load_ranking)

# 게임 오버 처리
def game_over():
    global game_running
    game_running = False
    document['game-over'].style.display = 'block'
    document['final-score'].text = f"점수: {score}"
    # 랭킹 표시
    ranking_text = ""
    for idx, s in enumerate(ranking):
        ranking_text += f"{idx+1}위: {s}<br>"
    if len(ranking)<5 or score <= ranking[-1]:
        ranking_text += "5등 안에 못 들었습니다"
    document['ranking'].html = ranking_text

# 게임 시작
def start_game(ev):
    global game_running, player, bullets, score
    game_running = True
    player['x'], player['y'] = canvas_width//2, canvas_height//2
    bullets.clear()
    score = 0
    document['game-over'].style.display = 'none'
    timer.set_timeout(game_loop, 16)
document['start-btn'].bind('click', start_game)

# 총알 생성
import random
def spawn_bullet():
    side = random.choice(['top','bottom','left','right'])
    if side=='top':
        x = random.randint(0, canvas_width)
        y = -20
        dx = 0
        dy = random.randint(3,6)
    elif side=='bottom':
        x = random.randint(0, canvas_width)
        y = canvas_height + 20
        dx = 0
        dy = -random.randint(3,6)
    elif side=='left':
        x = -20
        y = random.randint(0, canvas_height)
        dx = random.randint(3,6)
        dy = 0
    else:
        x = canvas_width + 20
        y = random.randint(0, canvas_height)
        dx = -random.randint(3,6)
        dy = 0
    bullets.append({'x':x,'y':y,'dx':dx,'dy':dy})

# 게임 루프
def game_loop(timestamp=None):
    global score
    if not game_running:
        return
    ctx.clearRect(0,0,canvas_width,canvas_height)
    # 배경 그리기
    ctx.drawImage(bg,0,0,canvas_width,canvas_height)
    # 총알 이동
    for b in bullets:
        b['x'] += b['dx']
        b['y'] += b['dy']
        ctx.drawImage(bullet_img,b['x'],b['y'],bullet_img.width*3, bullet_img.height*3)
        # 충돌 판정
        if abs(b['x']-player['x']) < player['w']*0.2 and abs(b['y']-player['y']) < player['h']*0.5:
            game_over()
            return
    # 플레이어 그리기
    ctx.drawImage(player_img, player['x'], player['y'], player['w'], player['h'])
    score += 1
    document['score'].text = f"점수: {score}"
    # 총알 생성 랜덤
    if random.random() < 0.03:
        spawn_bullet()
    timer.set_timeout(game_loop, 16)
timer.set_timeout(game_loop, 16)

# PC 키보드 이동
def on_key(ev):
    step = 10
    if ev.key in ['ArrowLeft','a']: player['x'] -= step
    elif ev.key in ['ArrowRight','d']: player['x'] += step
    elif ev.key in ['ArrowUp','w']: player['y'] -= step
    elif ev.key in ['ArrowDown','s']: player['y'] += step
document.bind('keydown', on_key)

# 모바일 터치 이동
touching = False
def on_touch_start(ev):
    global touching
    touching = True
def on_touch_move(ev):
    if touching:
        player['x'] = ev.touches[0].clientX - stage.offsetLeft
        player['y'] = ev.touches[0].clientY - stage.offsetTop
def on_touch_end(ev):
    global touching
    touching = False
stage.bind('touchstart', on_touch_start)
stage.bind('touchmove', on_touch_move)
stage.bind('touchend', on_touch_end)
</script>
</body>
</html>
